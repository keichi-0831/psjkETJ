<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥è°·å¼€å›¢æ‰“è¡¨æœº</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap');

        :root {
            /* è‰²å½©æ­é… (ä½é¥±å’Œåº¦) */
            --bg-color: #fff9f0;
            --card-bg: #feeede;
            --primary-color: #c08585;
            --primary-hover-color: #a87171;
            --secondary-color: #c08585;
            /* åŒä¸»è‰² */
            --accent-color: #c08585;
            /* åŒä¸»è‰²ï¼Œç”¨äºåˆ é™¤ã€è­¦ç¤º */
            --accent-hover-color: #a87171;
            --success-color: #7a9b76;
            --success-hover-color: #678563;
            --text-color: #5c4e4e;
            --light-text-color: #8c7f7f;
            --border-color: #e6d8c1;
            --highlight-bg: #fff5e8;

            /* è®¾è®¡é£æ ¼ */
            --shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
            --border-radius: 8px;
        }

        body {
            font-family: 'Nunito', 'Microsoft YaHei', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 1300px;
        }

        h1,
        h2 {
            color: var(--secondary-color);
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.05);
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 2.5em;
        }

        h2 {
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            margin-top: 40px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .export-title-btn {
            font-size: 0.6em;
            padding: 5px 10px;
            background-color: var(--success-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-family: inherit;
            font-weight: 600;
            transition: background-color 0.2s;
            text-decoration: none;
            flex-shrink: 0;
            /* é˜²æ­¢æŒ‰é’®è¢«å‹ç¼© */
        }

        .export-title-btn:hover {
            background-color: var(--success-hover-color);
        }

        h3 {
            color: var(--primary-color);
            border-left: 4px solid var(--primary-color);
            padding-left: 10px;
            margin-top: 20px;
            display: flex;
            align-items: center;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--light-text-color);
        }

        .input-group input[type="number"],
        .input-group input[type="text"] {
            width: 100%;
            max-width: 200px;
            /* æ§åˆ¶é…ç½®åŒºè¾“å…¥æ¡†æœ€å¤§å®½åº¦ */
            padding: 8px 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-family: inherit;
            font-size: 1em;
            transition: border-color 0.2s, box-shadow 0.2s;
            box-sizing: border-box;
            background-color: var(--highlight-bg);
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(192, 133, 133, 0.3);
        }

        .result-field {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 1.1em;
            padding: 8px 10px;
            background-color: var(--highlight-bg);
            border-radius: var(--border-radius);
            display: inline-block;
            min-width: 40px;
            text-align: center;
        }

        .info-text {
            font-size: 0.9em;
            color: var(--light-text-color);
            margin-top: 8px;
            background: var(--highlight-bg);
            padding: 8px;
            border-radius: var(--border-radius);
            white-space: pre-wrap;
        }

        .warning-text {
            font-size: 0.8em;
            color: var(--accent-color);
            margin-left: 5px;
        }

        button,
        .button,
        .add-row-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-family: inherit;
            font-weight: 600;
            transition: background-color 0.2s;
            display: inline-block;
            text-decoration: none;
        }

        button:hover,
        .button:hover,
        .add-row-btn:hover {
            background-color: var(--primary-hover-color);
        }

        .add-row-btn {
            background-color: var(--highlight-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            margin-top: 10px;
        }

        .add-row-btn:hover {
            background-color: #f7e3a2;
        }

        .remove-btn-text,
        .add-btn-text {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.5em;
            font-weight: bold;
            padding: 0 5px;
            vertical-align: middle;
            line-height: 1;
            transition: color 0.2s;
        }

        .remove-btn-text {
            color: var(--accent-color);
        }

        .add-btn-text {
            color: var(--success-color);
        }

        .remove-btn-text:hover {
            color: var(--accent-hover-color);
        }

        .add-btn-text:hover {
            color: var(--success-hover-color);
        }

        .tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-button {
            background-color: var(--highlight-bg);
            color: var(--text-color);
        }

        .tab-button.active {
            background-color: var(--primary-color);
            color: white;
        }

        .item-tab-button.add-new-item-type-btn {
            background-color: var(--success-color);
            color: white;
        }

        .item-tab-button.add-new-item-type-btn:hover {
            background-color: var(--success-hover-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        table {
            table-layout: fixed;
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th,
        td {
            border: 1px solid var(--border-color);
            padding: 10px;
            text-align: center;
            vertical-align: middle;
        }

        th {
            background-color: var(--highlight-bg);
            font-weight: 600;
            color: var(--text-color);
        }

        /* --- æ ¸å¿ƒï¼šè¡¨æ ¼å†…è¾“å…¥æ¡†å®½åº¦æ§åˆ¶ --- */
        td input[type="text"],
        td input[type="number"] {
            width: 100%;
            box-sizing: border-box;
            /* å…³é”®ï¼šè®©paddingä¸å¢åŠ å®½åº¦ */
            padding: 8px 10px;
            margin: 0 auto;
            /* åœ¨å•å…ƒæ ¼å†…å±…ä¸­ */
        }

        td.col-name input[type="text"] {
            max-width: 160px;
            /* è§’è‰²å/ç§ç±»ç­‰æ–‡æœ¬æ¡†çš„æœ€å¤§å®½åº¦ */
        }

        td.col-value input[type="number"] {
            max-width: 80px;
            /* è°ƒä»·/åŸä»·ç­‰æ•°å­—æ¡†çš„æœ€å¤§å®½åº¦ */
        }

        /* --- ç»“æŸï¼šè¡¨æ ¼å†…è¾“å…¥æ¡†å®½åº¦æ§åˆ¶ --- */


        th.col-name,
        td.col-name {
            min-width: 120px;
        }

        th.col-value,
        td.col-value {
            width: 90px;
        }

        th.col-distribution,
        td.col-distribution {
            min-width: 190px;
        }

        th.col-operation,
        td.col-operation {
            width: 70px;
        }

        .table-scroll-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-top: 10px;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
        }

        .table-scroll-wrapper table {
            min-width: 780px;
            border: none;
        }

        .distribution-container {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .dist-entry {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .dist-entry input[type="text"] {
            flex: 2;
            min-width: 70px;
            padding: 6px 8px;
            box-sizing: border-box;
        }

        .dist-entry input[type="number"] {
            flex: 1;
            min-width: 50px;
            padding: 6px 8px;
            box-sizing: border-box;
        }

        .item-config-header {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 10px;
            align-items: center;
        }

        .item-config-header .input-group {
            margin: 0;
        }

        #total-bill-output,
        #total-items-output,
        #check-total-output {
            margin-top: 15px;
            padding: 15px;
            background-color: var(--highlight-bg);
            border-radius: var(--border-radius);
            white-space: pre-wrap;
            font-family: 'Courier New', Courier, monospace;
        }

        .calc-section {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 15px;
        }

        .footer-credit {
            font-style: italic;
            opacity: 0.6;
            text-align: center;
            margin-top: 10px;
            margin-bottom: 10px;
            color: var(--light-text-color);
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        #archive-button,
        #load-button,
        #data-sync-button {
            background-color: var(--success-color);
        }

        #archive-button:hover,
        #load-button:hover,
        #data-sync-button:hover {
            background-color: var(--success-hover-color);
        }

        #reset-button {
            background-color: var(--accent-color);
        }

        #reset-button:hover {
            background-color: var(--accent-hover-color);
        }

        #export-table-button {
            background-color: var(--primary-color);
        }

        #export-table-button:hover {
            background-color: var(--primary-hover-color);
        }

        #export-options-modal,
        #data-sync-modal,
        #load-modal {
            display: none;
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--card-bg);
            padding: 25px;
            border: 1px solid var(--border-color);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.25);
            z-index: 1000;
            border-radius: var(--border-radius);
            width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }

        #export-options-modal h3,
        #data-sync-modal h3,
        #load-modal h3 {
            margin-top: 0;
            margin-bottom: 15px;
            text-align: center;
            color: var(--primary-color);
        }

        .modal-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-family: inherit;
            font-weight: 600;
            display: block;
            margin: 10px 0;
            width: 100%;
            text-align: center;
            transition: background-color 0.2s;
        }

        .modal-button:hover {
            background-color: var(--primary-hover-color);
        }

        #export-options-modal .cancel-button,
        #data-sync-modal .cancel-button,
        #load-modal .cancel-button {
            background-color: var(--light-text-color);
        }

        #export-options-modal .cancel-button:hover,
        #data-sync-modal .cancel-button:hover,
        #load-modal .cancel-button:hover {
            background-color: #555555;
        }

        /* Autocomplete Box */
        #autocomplete-suggestions {
            display: none;
            position: fixed;
            border: 1px solid var(--border-color);
            background-color: #fffaf0;
            /* A bit lighter for popups */
            z-index: 1002;
            max-height: 150px;
            overflow-y: auto;
            box-shadow: var(--shadow);
            border-radius: var(--border-radius);
        }

        .suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
            color: var(--text-color);
            font-size: 0.9em;
        }

        .suggestion-item:hover,
        .suggestion-item.active {
            background-color: var(--highlight-bg);
            color: var(--secondary-color);
        }

        /* --- çš®è‚¤æ›´æ¢å™¨ --- */
        .skin-changer {
            position: fixed;
            top: 15px;
            right: 20px;
            z-index: 1001;
            text-align: right;
        }

        #skin-button {
            background-color: rgba(128, 128, 128, 0.3);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 5px 10px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-family: inherit;
            font-weight: 600;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
            opacity: 0.7;
        }

        #skin-button:hover {
            background-color: rgba(128, 128, 128, 0.5);
            opacity: 1;
        }

        #skin-options {
            display: flex;
            gap: 10px;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            margin-top: 5px;
            box-shadow: var(--shadow);
            transition: border-color 0.2s;
        }

        #skin-options.hidden {
            display: none;
        }

        .skin-color-circle {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s, border-color 0.2s;
        }

        .skin-color-circle:hover {
            transform: scale(1.15);
        }

        .skin-color-circle.active {
            border-color: var(--primary-color);
            transform: scale(1.15);
        }

        /* èµ å“æ ‡è®°è¡Œæ ·å¼ */
        .gift-marker-row {
            background-color: var(--highlight-bg) !important;
        }

        .gift-marker-row td {
            padding: 12px !important;
        }

        /* èµ å“è¡Œæ ·å¼ */
        .gift-row {
            background-color: var(--highlight-bg) !important;
        }

        .gift-row input[type="text"],
        .gift-row input[type="number"] {
            background-color: white;
        }

        .gift-row td {
            padding: 10px !important;
        }

        /* è‚¾è¡¨å’Œæ’è¡¨çš„ç¾åŒ–æ ·å¼ */
        .person-bill-item {
            padding: 8px 12px;
            margin: 5px 0;
            background-color: var(--highlight-bg);
            border-radius: 4px;
            border-left: 3px solid var(--primary-color);
        }

        .person-items-section {
            margin-bottom: 15px;
            padding: 10px;
            background-color: var(--highlight-bg);
            border-radius: 4px;
        }

        .person-name {
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border-color);
        }

        .item-line {
            padding: 3px 0 3px 15px;
            color: var(--text-color);
        }

        /* é€€è¡¥å·®é¢ä¸¤åˆ—å¸ƒå±€ */
        .refund-payment-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 10px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-header>h3 {
            margin-top: 0;
            /* å°†å¤–è¾¹è·äº¤ç»™å®¹å™¨å¤„ç† */
        }


        .refund-column {
            background-color: #e8f5e9;
            padding: 15px;
            border-radius: var(--border-radius);
            border: 1px solid #c8e6c9;
        }

        .refund-column::before {
            content: "ğŸ’° éœ€é€€æ¬¾";
            display: block;
            font-weight: bold;
            color: #2e7d32;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid #c8e6c9;
        }

        .payment-column {
            background-color: #ffebee;
            padding: 15px;
            border-radius: var(--border-radius);
            border: 1px solid #ffcdd2;
        }

        .payment-column::before {
            content: "ğŸ’¸ éœ€è¡¥æ¬¾";
            display: block;
            font-weight: bold;
            color: #c62828;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid #ffcdd2;
        }

        .refund-item,
        .payment-item {
            padding: 8px 12px;
            margin: 5px 0;
            background-color: white;
            border-radius: 4px;
            font-weight: 500;
        }

        .refund-item {
            color: #2e7d32;
            border-left: 3px solid #4caf50;
        }

        .payment-item {
            color: #c62828;
            border-left: 3px solid #f44336;
        }
    </style>
</head>

<body>

    <div class="skin-changer">
        <button id="skin-button">skin</button>
        <div id="skin-options" class="hidden">
            <!-- ä¸»é¢˜é¢œè‰²é€‰é¡¹ä¼šç”±JavaScriptåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
    </div>

    <div class="container">
        <h1>æ—¥è°·å¼€å›¢æ‰“è¡¨æœº ğŸ’–</h1>
        <p class="footer-credit" style="margin-top: -10px; margin-bottom: 20px;">All by keichi</p>

        <div class="action-buttons">
            <button id="archive-button" onclick="archiveData()">ğŸ’¾ å­˜å‚¨æ¡£æ¡ˆ</button>
            <button id="load-button" onclick="showLoadModal()">ğŸ“‚ è¯»å–æ¡£æ¡ˆ</button>
            <button id="reset-button" onclick="resetCurrentSlotData()">ğŸ”„ é‡ç½®æ•°æ®</button>
            <button id="data-sync-button" onclick="showDataSyncModal()">ğŸ“¡ æ•°æ®äº’é€š</button>
        </div>

        <p id="current-slot-display"
            style="color: var(--primary-color); font-size: 0.9em; font-weight: bold; margin-bottom: 2px; text-align: left;">
            å½“å‰å­˜æ¡£: -</p>
        <p id="last-auto-save-time"
            style="color: var(--light-text-color); font-size: 0.9em; font-style: italic; margin-bottom: 10px; text-align: left;">
            ä¸Šæ¬¡è‡ªåŠ¨ä¿å­˜æ—¶é—´: å°šæœªè‡ªåŠ¨ä¿å­˜</p>

        <div class="card">
            <div class="input-group" style="display: flex; align-items: center; gap: 10px; margin: 0;">
                <label for="exchange-rate" style="font-weight: bold; margin: 0;">å½“æœŸæ±‡ç‡ï¼š</label>
                <input type="number" id="exchange-rate" placeholder="55" style="width: 80px; max-width: 80px;"
                    oninput="updateAllPrices()">
                <span>æ±‡</span>
                <span class="info-text" style="margin: 0; padding: 5px 8px; font-size: 0.8em;">(ä¾‹: è¾“å…¥55æ±‡ = è¯¥ä»·æ ¼ *
                    0.055)</span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="showTab('tables-section')">æ’è¡¨</button>
            <button class="tab-button" onclick="showTab('remaining-section')">ä½™é‡</button>
            <button class="tab-button" onclick="showTab('summary-section')">è‚¾è¡¨</button>
        </div>

        <section id="tables-section" class="card tab-content active">
            <h2>ã€æ’è¡¨ã€‘<button class="export-title-btn" onclick="exportTablesData()">ã€å¯¼å‡ºExcelã€‘</button></h2>
            <div class="tabs" id="item-tabs"></div>
            <div id="item-tables-container"></div>
        </section>

        <section id="remaining-section" class="card tab-content">
            <h2>ã€ä½™é‡ã€‘<button class="export-title-btn" onclick="exportRemainingData()">ã€å¯¼å‡ºExcelã€‘</button></h2>
            <button onclick="updateRemainingTable()">ğŸ”„ æ›´æ–°ä½™é‡</button>
            <div class="copy-button-container" style="position: relative; margin-top: 10px;">
                <button class="copy-button" onclick="copyToClipboard('remaining-output', this)"
                    style="position: absolute; top: 10px; right: 10px; z-index: 1;">ğŸ“‹ å¤åˆ¶</button>
                <div id="remaining-output" style="margin-top: 20px;">
                    <p style="color: var(--light-text-color); text-align: center; font-style: italic;">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ›´æ–°ä½™é‡è¡¨æ ¼...
                    </p>
                </div>
            </div>
        </section>

        <section id="summary-section" class="card tab-content">
            <h2>ã€è‚¾è¡¨ã€‘<button class="export-title-btn" onclick="exportSummaryData()">ã€å¯¼å‡ºExcelã€‘</button></h2>
            <button onclick="calculateSummary()">ğŸš€ è®¡ç®—æ€»è‚¾è¡¨ & æ€»æ’è¡¨</button>
            <div
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; margin-top: 20px;">
                <div class="calc-section">
                    <div class="section-header">
                        <h3>æœ¬æ¬¡è‚¾è¡¨</h3>
                        <button class="copy-button" onclick="copyToClipboard('total-bill-output', this)">ğŸ“‹ å¤åˆ¶</button>
                    </div>
                    <div id="total-bill-output">ç‚¹å‡»æŒ‰é’®è®¡ç®—...</div>

                </div>
                <div class="calc-section">
                    <div class="section-header">
                        <h3>æœ¬æ¬¡æ’è¡¨</h3>
                        <button class="copy-button" onclick="copyToClipboard('total-items-output', this)">ğŸ“‹ å¤åˆ¶</button>
                    </div>
                    <div id="total-items-output">ç‚¹å‡»æŒ‰é’®è®¡ç®—...</div>

                </div>
            </div>

            <h2 style="margin-top: 40px;">ã€å›½é™…è‚¾è¡¨ã€‘</h2>
            <div class="calc-section">
                <div class="copy-button-container" style="position: relative;">
                    <button class="copy-button" onclick="copyToClipboard('shipping-bill-output', this)"
                        style="position: absolute; top: -5px; right: 0;">ğŸ“‹ å¤åˆ¶</button>
                    <div id="shipping-bill-output">ç‚¹å‡»æŒ‰é’®è®¡ç®—...</div>
                </div>
            </div>

            <h2 style="margin-top: 40px;">ã€å®é™…å‡ºè·ã€‘</h2>
            <div
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; margin-top: 20px;">
                <div class="calc-section">
                    <div class="section-header">
                        <h3>å®é™…è‚¾è¡¨</h3>
                        <button class="copy-button" onclick="copyToClipboard('actual-bill-output', this)">ğŸ“‹ å¤åˆ¶</button>
                    </div>
                    <div id="actual-bill-output">ç‚¹å‡»æŒ‰é’®è®¡ç®—...</div>

                </div>
                <div class="calc-section">
                    <div class="section-header">
                        <h3>å®é™…æ’è¡¨</h3>
                        <button class="copy-button" onclick="copyToClipboard('actual-items-output', this)">ğŸ“‹
                            å¤åˆ¶</button>
                    </div>
                    <div id="actual-items-output">ç‚¹å‡»æŒ‰é’®è®¡ç®—...</div>

                </div>
                <div class="calc-section" style="grid-column: 1 / -1;">
                    <div class="section-header">
                        <h3>é€€è¡¥å·®é¢</h3>
                        <button class="copy-button" onclick="copyToClipboard('refund-output', this)">ğŸ“‹ å¤åˆ¶</button>
                    </div>
                    <div id="refund-output" class="refund-payment-grid">ç‚¹å‡»æŒ‰é’®è®¡ç®—...</div>

                </div>
            </div>

            <h2 style="margin-top: 40px;">ã€è‚¾é¢æ ¸å¯¹ã€‘</h2>
            <div class="calc-section">
                <div id="check-total-output">
                    <p>åº”ä»˜æ€»é¢: <span id="expected-total" class="result-field">0.00</span> å…ƒ</p>
                    <p>å®æ”¶æ€»é¢: <span id="actual-total" class="result-field">0.00</span> å…ƒ</p>
                    <p id="check-diff" class="info-text"></p>
                </div>
            </div>
        </section>

        <p class="footer-credit">All by keichi</p>

        <div id="data-sync-modal">
            <h3>æ•°æ®äº’é€š</h3>
            <button class="modal-button" onclick="exportAllDataAsJson(); hideDataSyncModal();">å¯¼å‡ºå…¨éƒ¨æ•°æ® (JSON)</button>
            <input type="file" id="json-import-file" accept=".json" style="display: none;"
                onchange="handleJsonFileImport(event)">
            <button class="modal-button" onclick="document.getElementById('json-import-file').click();">å¯¼å…¥æ•°æ®
                (JSON)</button>
            <button class="modal-button cancel-button" onclick="hideDataSyncModal();">å–æ¶ˆ</button>
        </div>

        <div id="load-modal">
            <h3>é€‰æ‹©è¦è¯»å–çš„æ¡£æ¡ˆ</h3>
            <div id="load-modal-list"></div>
            <button class="modal-button cancel-button" onclick="hideLoadModal()">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="autocomplete-suggestions"></div>

    <script>
        const SAVE_MANIFEST_KEY = 'keichiKiguSaves-v2.1';
        const ACTIVE_SLOT_KEY = 'keichiKiguActiveSlot-v2.1';
        const DEFAULT_SLOT_NAME = 'é»˜è®¤å­˜æ¡£';
        const LAST_AUTO_SAVE_TIME_KEY_PREFIX = 'keichiKiguLastAutoSave-v2.1_';
        let currentSlotName = DEFAULT_SLOT_NAME;
        let dynamicItemCounter = 0;
        let lastAutoSaveTimestamp = null;

        let itemTypes = {};
        const initialItemTypes = {
            'boxA': {
                id_prefix: 'boxA', key: 'ç›’A',
                defaults: { name: 'ç›’A', price: 2750, chars: 8, sets: 0, bonusPrice: 0 },
                hasChars: true, hasSets: true, setsLabel: 'ç›’æ•°', hasBonusPrice: true, isDynamic: false,
            },
            'boxB': {
                id_prefix: 'boxB', key: 'ç›’B',
                defaults: { name: 'ç›’B', price: 2750, chars: 8, sets: 0, bonusPrice: 0 },
                hasChars: true, hasSets: true, setsLabel: 'ç›’æ•°', hasBonusPrice: true, isDynamic: false,
            },
            'single': { id_prefix: 'single', key: 'å•é¢†', isDynamicTabContent: true, isDynamic: false },
            'bonus': { id_prefix: 'bonus', key: 'ç‰¹å…¸', isDynamicTabContent: true, isDynamic: false },
            'shipping': { id_prefix: 'shipping', key: 'å›½é™…é‚®è´¹', isShippingFee: true, isDynamic: false }
        };
        let orderedTypesForTabs = ['boxA', 'boxB', 'single', 'bonus', 'shipping'];

        // --- çš®è‚¤æ›´æ¢å™¨é€»è¾‘ ---
        const THEME_STORAGE_KEY = 'keichiKiguTheme-v1';
        const themes = {
            'original': {
                name: '1',
                colors: {
                    '--bg-color': '#fff9f0',
                    '--card-bg': '#feeede',
                    '--primary-color': '#c08585',
                    '--primary-hover-color': '#a87171',
                    '--secondary-color': '#c08585',
                    '--accent-color': '#c08585',
                    '--accent-hover-color': '#a87171',
                    '--success-color': '#7a9b76',
                    '--success-hover-color': '#678563',
                    '--text-color': '#5c4e4e',
                    '--light-text-color': '#8c7f7f',
                    '--border-color': '#e6d8c1',
                    '--highlight-bg': '#fff5e8',
                }
            },
            'blue-pink': {
                name: '2',
                colors: {
                    '--bg-color': '#eaf2f8',
                    '--card-bg': '#ffffff',
                    '--primary-color': '#97c6da', // æ›´æ¸…æ™°çš„è“è‰²
                    '--primary-hover-color': '#8295cd',
                    '--secondary-color': '#edaabc', // æ›´æ¸…æ™°çš„ç²‰çº¢è‰²/çº¢è‰²ç³»æ ‡é¢˜
                    '--accent-color': '#d78996', // é‡ç½®/åˆ é™¤æŒ‰é’®
                    '--accent-hover-color': '#ee6593',
                    '--success-color': '#f2d4ec',
                    '--success-hover-color': '#e6a8d7',
                    '--text-color': '#34495e', // å¤§å¹…åŠ æ·±çš„æ–‡å­—é¢œè‰²
                    '--light-text-color': '#7f8c8d', // å¤§å¹…åŠ æ·±çš„æ¬¡è¦æ–‡å­—é¢œè‰²
                    '--border-color': '#dce4ec',
                    '--highlight-bg': '#fff0f0', // è¾“å…¥æ¡†å†…æ·¡æ·¡çš„ç²‰è‰²
                }
            }
            // æœªæ¥å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ›´å¤šä¸»é¢˜
        };

        function applyTheme(themeName) {
            const theme = themes[themeName];
            if (!theme) {
                console.error(`ä¸»é¢˜ "${themeName}" æœªæ‰¾åˆ°ã€‚`);
                return;
            }

            const root = document.documentElement;
            for (const [variable, value] of Object.entries(theme.colors)) {
                root.style.setProperty(variable, value);
            }

            // æ›´æ–°æ¿€æ´»çŠ¶æ€çš„åœ†åœˆ
            document.querySelectorAll('.skin-color-circle').forEach(circle => {
                circle.classList.toggle('active', circle.dataset.theme === themeName);
            });

            localStorage.setItem(THEME_STORAGE_KEY, themeName);
        }

        function initSkinChanger() {
            const skinButton = document.getElementById('skin-button');
            const skinOptions = document.getElementById('skin-options');

            if (!skinButton || !skinOptions) return;

            // åŠ¨æ€ç”Ÿæˆé¢œè‰²é€‰é¡¹
            for (const [key, theme] of Object.entries(themes)) {
                const circle = document.createElement('div');
                circle.className = 'skin-color-circle';
                // åœ†åœˆçš„é¢œè‰²ä½¿ç”¨ä¸»é¢˜çš„èƒŒæ™¯è‰²æ¥ä»£è¡¨
                circle.style.backgroundColor = theme.colors['--bg-color'];
                circle.title = theme.name;
                circle.dataset.theme = key;
                circle.addEventListener('click', () => {
                    applyTheme(key);
                });
                skinOptions.appendChild(circle);
            }

            // ç‚¹å‡»æŒ‰é’®æ—¶åˆ‡æ¢æ˜¾ç¤º/éšè—
            skinButton.addEventListener('click', (e) => {
                e.stopPropagation();
                skinOptions.classList.toggle('hidden');
            });

            // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹æ—¶éšè—
            document.addEventListener('click', (e) => {
                if (!skinOptions.contains(e.target) && !skinOptions.classList.contains('hidden')) {
                    skinOptions.classList.add('hidden');
                }
            });

            // åŠ è½½å¹¶åº”ç”¨å·²ä¿å­˜çš„ä¸»é¢˜
            const savedTheme = localStorage.getItem(THEME_STORAGE_KEY);
            // å¦‚æœæœ‰å·²ä¿å­˜çš„ä¸»é¢˜ï¼Œåˆ™åº”ç”¨å®ƒï¼›å¦åˆ™ä½¿ç”¨é»˜è®¤çš„ 'original' ä¸»é¢˜
            if (savedTheme && themes[savedTheme]) {
                applyTheme(savedTheme);
            } else {
                applyTheme('original');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initSkinChanger();
            currentSlotName = localStorage.getItem(ACTIVE_SLOT_KEY) || DEFAULT_SLOT_NAME;
            document.getElementById('current-slot-display').textContent = `å½“å‰å­˜æ¡£: ${currentSlotName}`;

            updateLastAutoSaveTimeDisplay();
            loadData();

            showTab('tables-section');
            if (orderedTypesForTabs.length > 0) {
                const firstValidTab = orderedTypesForTabs.find(key => itemTypes[key]);
                if (firstValidTab) showItemTab(firstValidTab);
            }

            setInterval(() => saveData(true), 1000);
            window.addEventListener('beforeunload', () => saveData(true, false));

            setupAutocomplete();
        });

        function getExchangeRate() {
            return (parseFloat(document.getElementById('exchange-rate').value) || 0) * 0.001;
        }

        function updateLastAutoSaveTimeDisplay() {
            const displayElement = document.getElementById('last-auto-save-time');
            const savedTimestampStr = localStorage.getItem(LAST_AUTO_SAVE_TIME_KEY_PREFIX + currentSlotName);

            if (savedTimestampStr) {
                lastAutoSaveTimestamp = new Date(savedTimestampStr);
            } else {
                lastAutoSaveTimestamp = null;
            }

            if (displayElement && lastAutoSaveTimestamp) {
                const timeString = lastAutoSaveTimestamp.toLocaleString('zh-CN', {
                    year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
                }).replace(/\//g, '-');
                displayElement.textContent = `ä¸Šæ¬¡è‡ªåŠ¨ä¿å­˜æ—¶é—´: ${timeString}`;
            } else if (displayElement) {
                displayElement.textContent = 'ä¸Šæ¬¡è‡ªåŠ¨ä¿å­˜æ—¶é—´: å°šæœªè‡ªåŠ¨ä¿å­˜';
            }
        }

        function saveData(isAutoSave = false) {
            const data = {
                exchangeRate: document.getElementById('exchange-rate').value,
                tables: {},
                shippingTables: {}, // æ–°å¢ï¼šå­˜å‚¨å‡ºè·é…æ¯”æ•°æ®
                itemConfigs: {},
                dynamicTypeKeys: [],
                orderedTypesForTabs: [...orderedTypesForTabs],
                dynamicItemCounter: dynamicItemCounter,
            };

            Object.keys(itemTypes).forEach(typeKey => {
                const itemConfig = itemTypes[typeKey];
                if (!itemConfig) return;

                if (!itemConfig.isDynamicTabContent) {
                    data.itemConfigs[typeKey] = {
                        ...itemConfig,
                        defaults: itemConfig.defaults || {}
                    };
                }
                if (itemConfig.isDynamic) {
                    data.dynamicTypeKeys.push(typeKey);
                }

                const dataTableKey = itemConfig.key;

                // ä¿å­˜æ’è¡¨æ•°æ®
                data.tables[dataTableKey] = [];
                const table = document.getElementById(`data-table-${typeKey}`);
                if (table) {
                    table.querySelectorAll('tbody tr').forEach(row => {
                        const rowData = { distribution: [] };
                        let hasContent = false;

                        const charNameInput = row.querySelector('input[placeholder="è§’è‰²å..."]');
                        if (charNameInput) rowData.charName = charNameInput.value.trim();

                        const kindInput = row.querySelector('input[data-type="kind"]');
                        if (kindInput) rowData.kind = kindInput.value.trim();

                        if (rowData.charName || rowData.kind) hasContent = true;

                        const priceInput = row.querySelector('input[data-type="price"]');
                        if (priceInput) rowData.price = priceInput.value.trim();
                        if (rowData.price) hasContent = true;

                        const adjPriceInput = row.querySelector('.adj-price');
                        if (adjPriceInput) rowData.adjPrice = adjPriceInput.value;
                        if (parseFloat(rowData.adjPrice) !== 0) hasContent = true;

                        rowData.isAutoGen = row.dataset.autogen === 'true';

                        row.querySelectorAll('.dist-entry').forEach(entry => {
                            const name = entry.querySelector('.dist-name').value.trim();
                            const quantity = entry.querySelector('.dist-quantity').value.trim();
                            if (name || quantity) {
                                rowData.distribution.push({ name, quantity });
                                hasContent = true;
                            }
                        });

                        if (itemConfig.hasChars || hasContent) {
                            data.tables[dataTableKey].push(rowData);
                        }
                    });
                }
                // ä¿å­˜å›½é™…é‚®è´¹æ•°æ®
                if (typeKey === 'shipping') {
                    data.shippingFeeConfig = {
                        totalFee: document.getElementById('total-shipping-fee')?.value || '0',
                        pointsData: [],
                        customPointsData: [] // æ–°å¢ï¼šç”¨äºå­˜å‚¨è‡ªå®šä¹‰è¡Œ
                    };

                    const shippingTable = document.getElementById('shipping-fee-table');
                    if (shippingTable) {
                        shippingTable.querySelectorAll('tbody tr').forEach(row => {
                            const typeName = row.cells[0].textContent;
                            const pointsInput = row.querySelector('input[type="number"]');
                            if (pointsInput) {
                                data.shippingFeeConfig.pointsData.push({
                                    type: typeName,
                                    points: pointsInput.value
                                });
                            }
                        });
                    }
                    // æ–°å¢ï¼šä¿å­˜è‡ªå®šä¹‰è¡Œæ•°æ®
                    const customShippingTable = document.getElementById('custom-shipping-fee-table');
                    if (customShippingTable) {
                        customShippingTable.querySelectorAll('tbody tr').forEach(row => {
                            const nameInput = row.cells[0].querySelector('input');
                            const quantityInput = row.cells[1].querySelector('input');
                            const pointsInput = row.cells[2].querySelector('input');
                            if (nameInput && quantityInput && pointsInput) {
                                data.shippingFeeConfig.customPointsData.push({
                                    name: nameInput.value,
                                    quantity: quantityInput.value,
                                    points: pointsInput.value
                                });
                            }
                        });
                    }
                }


                // æ–°å¢ï¼šä¿å­˜å‡ºè·é…æ¯”æ•°æ®ï¼ˆåªé’ˆå¯¹ç›’å­ç±»å‹ï¼‰
                if (itemConfig.hasSets && !itemConfig.isDynamicTabContent) {
                    data.shippingTables[dataTableKey] = [];
                    const shippingTable = document.getElementById(`shipping-table-${typeKey}`);
                    if (shippingTable) {
                        shippingTable.querySelectorAll('tbody tr').forEach(row => {
                            const rowData = { distribution: [] };
                            let hasContent = false;

                            // æ£€æŸ¥æ˜¯å¦æ˜¯èµ å“è¡Œ
                            if (row.dataset.isgift === 'true') {
                                rowData.isGift = true;
                                const charNameInput = row.querySelector('input[placeholder="èµ å“è§’è‰²..."]');
                                if (charNameInput) rowData.charName = charNameInput.value.trim();
                                const giftPriceInput = row.querySelector('.gift-price');
                                if (giftPriceInput) rowData.giftPrice = giftPriceInput.value;
                                hasContent = true;
                            } else {
                                const charNameInput = row.querySelector('input[placeholder="è§’è‰²å..."]');
                                if (charNameInput) rowData.charName = charNameInput.value.trim();
                                if (rowData.charName) hasContent = true;

                                const adjPriceInput = row.querySelector('.adj-price');
                                if (adjPriceInput) rowData.adjPrice = adjPriceInput.value;
                                if (parseFloat(rowData.adjPrice) !== 0) hasContent = true;

                                rowData.isFromSync = row.dataset.fromsync === 'true';
                            }

                            row.querySelectorAll('.dist-entry').forEach(entry => {
                                const name = entry.querySelector('.dist-name').value.trim();
                                const quantity = entry.querySelector('.dist-quantity').value.trim();
                                if (name || quantity) {
                                    rowData.distribution.push({ name, quantity });
                                    hasContent = true;
                                }
                            });


                            if (hasContent) {
                                data.shippingTables[dataTableKey].push(rowData);
                            }
                        });
                    }
                }
            });

            const allSaves = JSON.parse(localStorage.getItem(SAVE_MANIFEST_KEY) || '{}');
            allSaves[currentSlotName] = data;
            localStorage.setItem(SAVE_MANIFEST_KEY, JSON.stringify(allSaves));

            if (isAutoSave) {
                lastAutoSaveTimestamp = new Date();
                localStorage.setItem(LAST_AUTO_SAVE_TIME_KEY_PREFIX + currentSlotName, lastAutoSaveTimestamp.toISOString());
                updateLastAutoSaveTimeDisplay();
            }
        }


        function loadData(importedData = null) {
            let dataToLoad = null;

            if (importedData) {
                dataToLoad = importedData;
            } else {
                const allSaves = JSON.parse(localStorage.getItem(SAVE_MANIFEST_KEY) || '{}');
                dataToLoad = allSaves[currentSlotName];
            }

            // Reset state before loading
            itemTypes = JSON.parse(JSON.stringify(initialItemTypes));
            orderedTypesForTabs = ['boxA', 'boxB', 'single', 'bonus', 'shipping'];
            dynamicItemCounter = 0;

            if (dataToLoad) {
                document.getElementById('exchange-rate').value = dataToLoad.exchangeRate || '';
                dynamicItemCounter = dataToLoad.dynamicItemCounter || 0;

                if (dataToLoad.orderedTypesForTabs) {
                    orderedTypesForTabs = [...dataToLoad.orderedTypesForTabs];
                }

                if (dataToLoad.itemConfigs) {
                    Object.keys(dataToLoad.itemConfigs).forEach(typeKey => {
                        // Either update existing or add new dynamic type
                        itemTypes[typeKey] = dataToLoad.itemConfigs[typeKey];
                    });
                }
            }

            orderedTypesForTabs = orderedTypesForTabs.filter(typeKey => itemTypes[typeKey]);

            generateTables(dataToLoad ? dataToLoad.tables : null, dataToLoad ? dataToLoad.shippingTables : null);

            // æ¢å¤å›½é™…é‚®è´¹æ•°æ®ï¼ˆå¿…é¡»åœ¨generateTablesä¹‹åï¼‰
            if (dataToLoad && dataToLoad.shippingFeeConfig) {
                setTimeout(() => {
                    const totalFeeInput = document.getElementById('total-shipping-fee');
                    if (totalFeeInput) {
                        totalFeeInput.value = dataToLoad.shippingFeeConfig.totalFee || '0';
                    }

                    updateShippingFeeTable(); // ç”Ÿæˆè‡ªåŠ¨è¡Œ

                    const tableBody = document.querySelector('#shipping-fee-table tbody');
                    if (tableBody && dataToLoad.shippingFeeConfig.pointsData) {
                        dataToLoad.shippingFeeConfig.pointsData.forEach(item => {
                            const row = Array.from(tableBody.rows).find(r =>
                                r.cells[0].textContent === item.type
                            );
                            if (row) {
                                const input = row.querySelector('input[type="number"]');
                                if (input) input.value = item.points;
                            }
                        });
                    }

                    // æ–°å¢ï¼šæ¢å¤è‡ªå®šä¹‰è¡Œ
                    if (dataToLoad.shippingFeeConfig.customPointsData) {
                        dataToLoad.shippingFeeConfig.customPointsData.forEach(customItem => {
                            addCustomShippingRow(customItem);
                        });
                    }

                    updateShippingFeeCalculation();
                }, 100);
            }


            updateAllPrices();

            if (importedData || !dataToLoad) {
                saveData(true);
            }
            updateNameCaches();
        }


        function resetCurrentSlotData() {
            if (confirm(`ç¡®å®šè¦é‡ç½®å½“å‰å­˜æ¡£ã€${currentSlotName}ã€‘çš„æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼`)) {
                const allSaves = JSON.parse(localStorage.getItem(SAVE_MANIFEST_KEY) || '{}');
                if (allSaves[currentSlotName]) {
                    delete allSaves[currentSlotName];
                    localStorage.setItem(SAVE_MANIFEST_KEY, JSON.stringify(allSaves));
                }
                localStorage.removeItem(LAST_AUTO_SAVE_TIME_KEY_PREFIX + currentSlotName);
                loadData(null); // Reload with no data
                alert('å½“å‰å­˜æ¡£æ•°æ®å·²é‡ç½®ï¼');
            }
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).style.display = 'block';
            document.querySelector(`button[onclick="showTab('${tabId}')"]`).classList.add('active');
        }

        function showItemTab(tabKeyToShow) {
            document.querySelectorAll('.item-tab-content').forEach(c => c.style.display = 'none');
            document.querySelectorAll('.item-tab-button').forEach(b => b.classList.remove('active'));

            const tabContent = document.getElementById(`table-${tabKeyToShow}`);
            if (tabContent) tabContent.style.display = 'block';

            const tabButton = document.querySelector(`.item-tab-button[data-tab="${tabKeyToShow}"]`);
            if (tabButton) tabButton.classList.add('active');
        }

        function updateItemConfigAndRecalculate(typeKeyChanged) {
            const itemConfig = itemTypes[typeKeyChanged];
            if (!itemConfig) return;
            const idPrefix = itemConfig.id_prefix;

            const nameInput = document.getElementById(`item-name-${idPrefix}`);
            const priceInput = document.getElementById(`item-price-${idPrefix}`);
            const charsInput = document.getElementById(`item-chars-${idPrefix}`);
            const setsInput = document.getElementById(`item-sets-${idPrefix}`);
            const bonusPriceInput = document.getElementById(`item-bonus-price-${idPrefix}`);

            if (!itemConfig.defaults) itemConfig.defaults = {};

            if (nameInput) {
                const newName = nameInput.value || itemConfig.key;
                itemConfig.key = newName;
                itemConfig.defaults.name = newName;
                document.querySelector(`.item-tab-button[data-tab='${typeKeyChanged}']`).textContent = `ã€${newName}ã€‘`;
                document.querySelector(`#table-${typeKeyChanged} h3`).childNodes[0].nodeValue = `${newName} æ’è¡¨`;
            }
            if (priceInput) itemConfig.defaults.price = priceInput.value;
            if (charsInput) itemConfig.defaults.chars = charsInput.value;
            if (setsInput) itemConfig.defaults.sets = setsInput.value;
            if (bonusPriceInput) itemConfig.defaults.bonusPrice = bonusPriceInput.value;

            updateAllPrices();
        }

        function handleCharacterCountChangeAndCalc(typeKeyChanged) {
            const itemConfig = itemTypes[typeKeyChanged];
            if (!itemConfig || !itemConfig.hasChars) return;

            const idPrefix = itemConfig.id_prefix;
            const tableBody = document.querySelector(`#data-table-${typeKeyChanged} tbody`);
            const charCountInput = document.getElementById(`item-chars-${idPrefix}`);
            const newCharCount = parseInt(charCountInput.value) || 0;

            if (itemConfig.defaults) itemConfig.defaults.chars = newCharCount.toString();

            if (!tableBody) return;
            const currentRows = Array.from(tableBody.rows);
            const currentRowCount = currentRows.length;

            if (newCharCount > currentRowCount) {
                for (let i = currentRowCount; i < newCharCount; i++) {
                    const newRow = tableBody.insertRow();
                    populateTableRow(newRow, typeKeyChanged, i, {});
                }
            } else if (newCharCount < currentRowCount) {
                for (let i = currentRowCount - 1; i >= newCharCount; i--) {
                    tableBody.deleteRow(i);
                }
            }
            updateAllPrices();
        }

        function generateTables(savedTableRows, savedShippingTableRows) {
            const tabsContainer = document.getElementById('item-tabs');
            const tablesContainer = document.getElementById('item-tables-container');
            tabsContainer.innerHTML = '';
            tablesContainer.innerHTML = '';

            orderedTypesForTabs.forEach((typeKey) => {
                const itemConfig = itemTypes[typeKey];
                if (!itemConfig) return;

                const idPrefix = itemConfig.id_prefix;
                const defaults = itemConfig.defaults || {};

                const button = document.createElement('button');
                button.className = 'item-tab-button';
                button.textContent = `ã€${defaults.name || itemConfig.key}ã€‘`;
                button.dataset.tab = typeKey;
                button.onclick = () => showItemTab(typeKey);
                tabsContainer.appendChild(button);

                const tableDiv = document.createElement('div');
                tableDiv.id = `table-${typeKey}`;
                tableDiv.className = 'item-tab-content';

                let configHTML = '';
                if (!itemConfig.isDynamicTabContent) {
                    configHTML += `<div class="item-config-header">
                <div class="input-group"><label>å•†å“å</label><input type="text" id="item-name-${idPrefix}" value="${defaults.name || ''}" oninput="updateItemConfigAndRecalculate('${typeKey}')"></div>
                <div class="input-group"><label>ä»·æ ¼</label><input type="number" id="item-price-${idPrefix}" value="${defaults.price || ''}" oninput="updateItemConfigAndRecalculate('${typeKey}')"></div>`;
                    if (itemConfig.hasChars) {
                        configHTML += `<div class="input-group"><label>è§’è‰²æ•°</label><input type="number" id="item-chars-${idPrefix}" value="${defaults.chars || ''}" min="0" oninput="handleCharacterCountChangeAndCalc('${typeKey}')"></div>`;
                    }
                    if (itemConfig.hasSets) {
                        configHTML += `<div class="input-group"><label>${itemConfig.setsLabel || 'é…æ•°'}</label><input type="number" id="item-sets-${idPrefix}" value="${defaults.sets || ''}" min="0" oninput="updateItemConfigAndRecalculate('${typeKey}')"></div>`;
                    }
                    if (itemConfig.hasBonusPrice) {
                        configHTML += `<div class="input-group"><label>æœ¬ç›’ç‰¹å…¸ä»·æ ¼</label><input type="number" id="item-bonus-price-${idPrefix}" value="${defaults.bonusPrice || ''}" oninput="updateItemConfigAndRecalculate('${typeKey}')"></div>`;
                    }
                    if (itemConfig.isDynamic) {
                        configHTML += `<button class="remove-btn-text" style="font-size:1em; padding:5px; background-color:var(--accent-color); color:white; border-radius:4px;" onclick="removeDynamicItemType('${typeKey}')">åˆ é™¤æ­¤å•†å“ç±»å‹</button>`;
                    }
                    configHTML += `</div>`;
                }

                // å›½é™…é‚®è´¹ç‰¹æ®Šå¤„ç†
                if (typeKey === 'shipping') {
                    let shippingHTML = `
                <div class="item-config-header">
                    <div class="input-group">
                        <label>æ€»å›½é™…é‚®è´¹ (å…ƒ)</label>
                        <input type="number" id="total-shipping-fee" value="0" oninput="updateShippingFeeCalculation()" style="max-width: 150px;">
                    </div>
                </div>
                <h3>å›½é™…é‚®è´¹åˆ†æ‘Šè¡¨ (è‡ªåŠ¨ç”Ÿæˆ)</h3>
                <div class="info-text" style="margin-bottom: 15px;">
                    ğŸ’¡ ç³»ç»Ÿä¼šè‡ªåŠ¨ç”Ÿæˆç›’å­å’Œå•é¢†çš„ç§ç±»ã€‚é»˜è®¤ç‚¹æ•°ä¸º1ï¼Œè¯·æ ¹æ®å®é™…é‡é‡ä¿®æ”¹ç‚¹æ•°ã€‚
                </div>
                <div class="table-scroll-wrapper">
                    <table id="shipping-fee-table">
                        <thead>
                            <tr>
                                <th class="col-name">ç§ç±»</th>
                                <th class="col-value">ç‚¹æ•°</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <h3 style="margin-top: 30px;">è‡ªå®šä¹‰é‚®è´¹é¡¹ç›®</h3>
                <div class="table-scroll-wrapper">
                    <table id="custom-shipping-fee-table">
                        <thead>
                            <tr>
                                <th class="col-name">ç§ç±»</th>
                                <th class="col-value">ä¸ªæ•°</th>
                                <th class="col-value">ç‚¹æ•°/ä¸ª</th>
                                <th class="col-operation">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <button class="add-row-btn" onclick="addCustomShippingRow()">æ·»åŠ ä¸€è¡Œ</button>
                <div id="shipping-fee-summary" class="info-text" style="margin-top: 15px;">
                    <p>æ€»é‚®è´¹ç‚¹æ•°: <span id="total-shipping-points" class="result-field">0</span></p>
                    <p>æ¯ç‚¹é‚®è´¹: <span id="per-point-fee" class="result-field">0.00</span> å…ƒ</p>
                </div>
            `;

                    tableDiv.innerHTML = shippingHTML;
                    tablesContainer.appendChild(tableDiv);
                    return; // å›½é™…é‚®è´¹è¡¨æ ¼ç‰¹æ®Šå¤„ç†ï¼Œç›´æ¥è¿”å›
                }

                // æ’è¡¨è¡¨æ ¼
                let tableTitle = `${defaults.name || itemConfig.key} æ’è¡¨`;
                let tableHTMLContent = `<div class="table-scroll-wrapper"><table id="data-table-${typeKey}"><thead><tr>`;

                if (typeKey === 'bonus') tableHTMLContent += `<th class="col-name">ç§ç±»</th><th class="col-value">ä»·å€¼</th><th class="col-value">è°ƒä»· <span id="è°ƒä»·æé†’-${typeKey}" class="warning-text"></span></th><th class="col-value">ç»ˆä»·</th><th class="col-distribution">æ’è¡¨</th><th class="col-value">ä½™é‡</th><th class="col-operation">æ“ä½œ</th>`;
                else if (typeKey === 'single') tableHTMLContent += `<th class="col-name">è§’è‰²</th><th class="col-name">ç§ç±»</th><th class="col-value">åŸä»·</th><th class="col-value">ç»ˆä»·</th><th class="col-distribution">æ’è¡¨</th><th class="col-operation">æ“ä½œ</th>`;
                else tableHTMLContent += `<th class="col-name">è§’è‰²</th><th class="col-value">å‡ä»·</th><th class="col-value">è°ƒä»· <span id="è°ƒä»·æé†’-${typeKey}" class="warning-text"></span></th><th class="col-value">ç»ˆä»·</th><th class="col-distribution">æ’è¡¨</th><th class="col-value">ä½™é‡</th>`;

                tableHTMLContent += `</tr></thead><tbody></tbody></table></div>`;

                if (itemConfig.isDynamicTabContent) {
                    tableHTMLContent += `<button class="add-row-btn" onclick="addDynamicRow('${typeKey}')">æ·»åŠ ä¸€è¡Œ</button>`;
                }
                tableHTMLContent += `<button onclick="calculatePageBill('${typeKey}')">è®¡ç®—æœ¬é¡µè‚¾è¡¨</button><div id="page-bill-${typeKey}" class="info-text" style="white-space: pre-wrap;"></div>`;

                // æ–°å¢ï¼šå‡ºè·é…æ¯”è¡¨æ ¼ï¼ˆåªé’ˆå¯¹ç›’å­ç±»å‹ï¼‰
                let shippingTableHTML = '';
                if (itemConfig.hasSets && !itemConfig.isDynamicTabContent) {
                    shippingTableHTML = `
                <h3 style="margin-top: 40px;">${defaults.name || itemConfig.key} å‡ºè·é…æ¯” 
                    <button onclick="syncToShippingTable('${typeKey}')" style="margin-left: 15px; font-size: 0.85em;">ğŸ“‹ åŒæ­¥æ’è¡¨</button>
                </h3>
                <div class="table-scroll-wrapper">
                    <table id="shipping-table-${typeKey}">
                        <thead>
                            <tr>
                                <th class="col-name">è§’è‰²</th>
                                <th class="col-value">å‡ä»·</th>
                                <th class="col-value">è°ƒä»· <span id="è°ƒä»·æé†’-shipping-${typeKey}" class="warning-text"></span></th>
                                <th class="col-value">ç»ˆä»·</th>
                                <th class="col-distribution">å‡ºè·é…æ¯”</th>
                                <th class="col-value">ä½™é‡</th>
                                <th class="col-operation">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                                     <p style="font-size: 0.85em; color: var(--light-text-color); margin-top: 10px; margin-bottom: 5px;">
                    ğŸ’¡ æç¤ºï¼šèµ å“å°†ç”¨äºé™ä½æœ¬ç›’å‡ä»·è®¡ç®—ï¼Œå…¬å¼ä¸º (æ€»ä»·Ã—æ±‡ç‡ - ç‰¹å…¸ä»·æ ¼ - èµ å“æ€»ä»·) Ã· è§’è‰²æ•°
                </p>
                <button class="add-row-btn" onclick="addGiftRow('${typeKey}')">ğŸ æ·»åŠ èµ å“</button>
    <div id="shipping-page-bill-${typeKey}" class="info-text" style="white-space: pre-wrap;"></div>
            `;
                }

                tableDiv.innerHTML = configHTML + `<h3>${tableTitle}</h3>` + tableHTMLContent + shippingTableHTML;
                tablesContainer.appendChild(tableDiv);

                // å¡«å……æ’è¡¨æ•°æ®
                const tableBody = document.querySelector(`#data-table-${typeKey} tbody`);
                const savedRowsForType = savedTableRows ? savedTableRows[itemConfig.key] : null;

                if (savedRowsForType && savedRowsForType.length > 0) {
                    savedRowsForType.forEach((rowData, i) => {
                        const newRow = tableBody.insertRow();
                        populateTableRow(newRow, typeKey, i, rowData);
                    });
                } else if (!itemConfig.isDynamicTabContent && itemConfig.hasChars) {
                    const targetCharCount = parseInt(defaults.chars) || 0;
                    for (let i = 0; i < targetCharCount; i++) {
                        const newRow = tableBody.insertRow();
                        populateTableRow(newRow, typeKey, i, {});
                    }
                }

                // æ–°å¢ï¼šå¡«å……å‡ºè·é…æ¯”æ•°æ®
                if (itemConfig.hasSets && !itemConfig.isDynamicTabContent) {
                    const shippingTableBody = document.querySelector(`#shipping-table-${typeKey} tbody`);
                    const savedShippingRows = savedShippingTableRows ? savedShippingTableRows[itemConfig.key] : null;

                    if (savedShippingRows && savedShippingRows.length > 0) {
                        savedShippingRows.forEach((rowData, i) => {
                            const newRow = shippingTableBody.insertRow();
                            populateShippingTableRow(newRow, typeKey, i, rowData, rowData.isGift || false, rowData.isFromSync || false);
                        });
                    }

                }
            });

            const addNewButton = document.createElement('button');
            addNewButton.textContent = '+ æ–°å¢å•†å“ç±»å‹';
            addNewButton.className = 'item-tab-button add-new-item-type-btn';
            addNewButton.onclick = addNewCustomItemType;
            tabsContainer.appendChild(addNewButton);
        }

        function addCustomShippingRow(data = {}) {
            const tableBody = document.querySelector('#custom-shipping-fee-table tbody');
            if (!tableBody) return;

            const newRow = tableBody.insertRow();
            newRow.innerHTML = `
        <td class="col-name"><input type="text" placeholder="è‡ªå®šä¹‰ç§ç±»" value="${data.name || ''}" oninput="updateShippingFeeCalculation()"></td>
        <td class="col-value"><input type="number" placeholder="ä¸ªæ•°" min="1" value="${data.quantity || '1'}" oninput="updateShippingFeeCalculation()"></td>
        <td class="col-value"><input type="number" placeholder="ç‚¹æ•°/ä¸ª" min="0" step="0.1" value="${data.points || '1'}" oninput="updateShippingFeeCalculation()"></td>
        <td class="col-operation"><button type="button" class="remove-btn-text" onclick="this.closest('tr').remove(); updateShippingFeeCalculation();">Ã—</button></td>
    `;
        }


        function populateTableRow(row, typeKey, index, data) {
            const itemConfig = itemTypes[typeKey];
            row.dataset.type = typeKey;
            row.dataset.index = index;
            row.dataset.autogen = data.isAutoGen || false;

            const onInputDist = 'oninput="updateAllPrices()"';
            const onKeyDown = `handleDistroInput(event, '${typeKey}')`;

            const distCellContent = (distDataArray = []) => {
                let content = `<div class="distribution-container">`;
                (distDataArray.length ? distDataArray : [{ name: '', quantity: '' }]).forEach(d => {
                    content += `<div class="dist-entry">
                        <input type="text" class="dist-name" placeholder="åå­—" value="${d.name || ''}" onkeydown="${onKeyDown}" ${onInputDist}>
                        <input type="number" class="dist-quantity" placeholder="æ•°é‡" min="0" value="${d.quantity || ''}" onkeydown="${onKeyDown}" ${onInputDist}>
                        <button type="button" class="remove-btn-text" onclick="removeDistributionEntry(this, '${typeKey}')">Ã—</button>
                    </div>`;
                });
                return content + `</div><button type="button" class="add-btn-text" onclick="addDistributionEntry(this, '${typeKey}')">+</button>`;
            };

            let rowHTML = '';
            if (typeKey === 'bonus') {
                const readonlyAttr = data.isAutoGen ? 'readonly' : '';
                rowHTML = `<td class="col-name"><input type="text" data-type="kind" value="${data.kind || ''}" ${readonlyAttr}></td>
                           <td class="col-value"><input type="number" data-type="price" value="${data.price || 0}" ${readonlyAttr}></td>
                           <td class="col-value"><input type="number" class="adj-price" value="${data.adjPrice || 0}" oninput="updateAllPrices()"></td>
                           <td class="col-value final-price">0.00</td>
                           <td class="col-distribution">${distCellContent(data.distribution)}</td>
                           <td class="col-value remaining-quantity">N/A</td>
                           <td class="col-operation"><button type="button" class="remove-btn-text" onclick="this.closest('tr').remove(); updateAllPrices();">Ã—</button></td>`;
            } else if (typeKey === 'single') {
                rowHTML = `<td class="col-name"><input type="text" placeholder="è§’è‰²å..." value="${data.charName || ''}"></td>
                           <td class="col-name"><input type="text" data-type="kind" placeholder="å•†å“ç§ç±»..." value="${data.kind || ''}"></td>
                           <td class="col-value"><input type="number" data-type="price" placeholder="åŸä»·(å††)" value="${data.price || 0}" oninput="updateAllPrices()"></td>
                           <td class="col-value final-price">0.00</td>
                           <td class="col-distribution">${distCellContent(data.distribution)}</td>
                           <td class="col-operation"><button type="button" class="remove-btn-text" onclick="this.closest('tr').remove()">Ã—</button></td>`;
            } else { // Box Types
                rowHTML = `<td class="col-name"><input type="text" placeholder="è§’è‰²å..." value="${data.charName || ''}"></td>
                           <td class="col-value avg-price">0.00</td>
                           <td class="col-value"><input type="number" class="adj-price" value="${data.adjPrice || 0}" oninput="updateAllPrices()"></td>
                           <td class="col-value final-price">0.00</td>
                           <td class="col-distribution">${distCellContent(data.distribution)}</td>
                           <td class="col-value remaining-quantity">N/A</td>`;
            }
            row.innerHTML = rowHTML;
        }

        function populateShippingTableRow(row, typeKey, index, data, isGift = false, isFromSync = false) {
            const itemConfig = itemTypes[typeKey];
            row.dataset.type = typeKey;
            row.dataset.index = index;
            row.dataset.isgift = isGift;
            row.dataset.fromsync = isFromSync;

            const onInputDist = 'oninput="updateAllPrices()"';
            const onKeyDown = `handleDistroInput(event, '${typeKey}', true)`;

            const distCellContent = (distDataArray = []) => {
                let content = `<div class="distribution-container">`;
                (distDataArray.length ? distDataArray : [{ name: '', quantity: '' }]).forEach(d => {
                    content += `<div class="dist-entry">
                        <input type="text" class="dist-name" placeholder="åå­—" value="${d.name || ''}" onkeydown="${onKeyDown}" ${onInputDist}>
                        <input type="number" class="dist-quantity" placeholder="æ•°é‡" min="0" value="${d.quantity || ''}" onkeydown="${onKeyDown}" ${onInputDist}>
                        <button type="button" class="remove-btn-text" onclick="removeDistributionEntry(this, '${typeKey}', true)">Ã—</button>
                    </div>`;
                });
                // ä¿®æ­£ï¼šæ— è®ºæ˜¯å¦åŒæ­¥ï¼Œéƒ½æ˜¾ç¤ºæ·»åŠ æŒ‰é’®
                return content + `<button type="button" class="add-btn-text" onclick="addDistributionEntry(this, '${typeKey}', true)">+</button>`;
            };

            let rowHTML = '';

            if (isGift) {
                // èµ å“è¡Œé€»è¾‘ä¸å˜
                row.classList.add('gift-row');
                rowHTML = `<td class="col-name"><input type="text" placeholder="èµ å“è§’è‰²..." value="${data.charName || ''}"></td>
                           <td class="col-value" colspan="2"><input type="number" class="gift-price" placeholder="ä»·æ ¼" value="${data.giftPrice || 0}" oninput="updateAllPrices()"></td>
                           <td class="col-value"></td>
                           <td class="col-distribution">${distCellContent(data.distribution)}</td>
                           <td class="col-value"></td>
                           <td class="col-operation"><button type="button" class="remove-btn-text" onclick="this.closest('tr').remove(); updateAllPrices();">Ã—</button></td>`;
            } else {
                // æ™®é€šè¡Œï¼ˆåŒ…æ‹¬åŒæ­¥è¡Œï¼‰çš„é€»è¾‘
                rowHTML = `<td class="col-name"><input type="text" placeholder="è§’è‰²å..." value="${data.charName || ''}" ${isFromSync ? 'readonly' : ''}></td>
                           <td class="col-value shipping-avg-price">0.00</td>
                           <td class="col-value"><input type="number" class="adj-price" value="${data.adjPrice || 0}" oninput="updateAllPrices()"></td>
                           <td class="col-value shipping-final-price">0.00</td>
                           <td class="col-distribution">${distCellContent(data.distribution)}</td>
                           <td class="col-value shipping-remaining-quantity">N/A</td>
                           <td class="col-operation">${isFromSync ? '<span style="font-size:0.8em; color:var(--light-text-color);">(åŒæ­¥)</span>' : '<button type="button" class="remove-btn-text" onclick="this.closest(\'tr\').remove(); updateAllPrices();">Ã—</button>'}</td>`;
            }

            row.innerHTML = rowHTML;
        }

        function addGiftRow(typeKey) {
            const tableBody = document.querySelector(`#shipping-table-${typeKey} tbody`);
            if (!tableBody) return;

            const newIndex = tableBody.rows.length;
            const newRow = tableBody.insertRow();
            populateShippingTableRow(newRow, typeKey, newIndex, {}, true, false);
            updateAllPrices();
        }

        function syncToShippingTable(typeKey) {
            const sourceTable = document.getElementById(`data-table-${typeKey}`);
            const targetTable = document.getElementById(`shipping-table-${typeKey}`);

            if (!sourceTable || !targetTable) return;

            if (!confirm('è¿™å°†è¦†ç›–å‡ºè·é…æ¯”è¡¨ä¸­çš„æ‰€æœ‰éèµ å“æ•°æ®ï¼Œç¡®å®šè¦åŒæ­¥å—ï¼Ÿ')) return;

            const targetBody = targetTable.querySelector('tbody');

            // ä¿å­˜ç°æœ‰çš„èµ å“è¡Œ
            const existingGiftRows = [];
            targetBody.querySelectorAll('tr[data-isgift="true"]').forEach(row => {
                const charName = row.querySelector('input[placeholder="èµ å“è§’è‰²..."]')?.value || '';
                const giftPrice = row.querySelector('.gift-price')?.value || 0;
                const distribution = [];
                row.querySelectorAll('.dist-entry').forEach(entry => {
                    const name = entry.querySelector('.dist-name').value.trim();
                    const quantity = entry.querySelector('.dist-quantity').value.trim();
                    if (name || quantity) {
                        distribution.push({ name, quantity });
                    }
                });
                existingGiftRows.push({ charName, giftPrice, distribution });
            });

            // æ¸…ç©ºè¡¨æ ¼
            targetBody.innerHTML = '';

            // æ·»åŠ åŒæ­¥çš„è¡Œ
            sourceTable.querySelectorAll('tbody tr').forEach((row, index) => {
                const charName = row.querySelector('input[placeholder="è§’è‰²å..."]')?.value || '';
                const adjPrice = row.querySelector('.adj-price')?.value || 0;

                const distribution = [];
                row.querySelectorAll('.dist-entry').forEach(entry => {
                    const name = entry.querySelector('.dist-name').value.trim();
                    const quantity = entry.querySelector('.dist-quantity').value.trim();
                    if (name || quantity) {
                        distribution.push({ name, quantity });
                    }
                });

                const newRow = targetBody.insertRow();
                populateShippingTableRow(newRow, typeKey, index, {
                    charName,
                    adjPrice,
                    distribution
                }, false, true); // isGift=false, isFromSync=true
            });

            // æ¢å¤èµ å“è¡Œ
            existingGiftRows.forEach((giftData, index) => {
                const newRow = targetBody.insertRow();
                populateShippingTableRow(newRow, typeKey, targetBody.rows.length, giftData, true, false);
            });

            updateAllPrices();
            alert('å·²åŒæ­¥ï¼èµ å“æ•°æ®å·²ä¿ç•™ã€‚');
        }


        function addDynamicRow(typeKey) {
            const tableBody = document.querySelector(`#data-table-${typeKey} tbody`);
            if (!tableBody) return;
            const newIndex = tableBody.rows.length;
            const newRow = tableBody.insertRow();
            populateTableRow(newRow, typeKey, newIndex, { isAutoGen: false });
        }

        function handleDistroInput(event, typeKey, isShipping = false) {
            if (event.key === 'Enter') {
                event.preventDefault();
                addDistributionEntry(event.target, typeKey, isShipping);
            }
        }


        function addDistributionEntry(element, typeKey, isShipping = false) {
            const container = element.closest('.col-distribution').querySelector('.distribution-container');
            const onInput = 'oninput="updateAllPrices()"';
            const onKeyDown = `handleDistroInput(event, '${typeKey}', ${isShipping})`;
            const newEntry = document.createElement('div');
            newEntry.className = 'dist-entry';
            newEntry.innerHTML = `<input type="text" class="dist-name" placeholder="åå­—" onkeydown="${onKeyDown}" ${onInput}><input type="number" class="dist-quantity" placeholder="æ•°é‡" min="0" value="" onkeydown="${onKeyDown}" ${onInput}><button type="button" class="remove-btn-text" onclick="removeDistributionEntry(this, '${typeKey}', ${isShipping})">Ã—</button>`;
            container.appendChild(newEntry);
            newEntry.querySelector('.dist-name').focus();
            updateAllPrices();
        }

        function removeDistributionEntry(button, typeKey, isShipping = false) {
            const entry = button.parentElement;
            const container = entry.parentElement;
            entry.remove();
            if (container.children.length === 0) addDistributionEntry(container.nextElementSibling, typeKey, isShipping);
            updateAllPrices();
        }

        function populateBonusTableFromItems() {
            const bonusTableBody = document.querySelector('#data-table-bonus tbody');
            if (!bonusTableBody) return;

            // 1. æ‰¾å‡ºæ‰€æœ‰åº”è¯¥å­˜åœ¨çš„ç‰¹å…¸ï¼Œä»¥åŠå®ƒä»¬çš„ä»·æ ¼
            const requiredBonuses = new Map();
            Object.keys(itemTypes).forEach(typeKey => {
                const itemConfig = itemTypes[typeKey];
                if (itemConfig && itemConfig.hasBonusPrice) {
                    const bonusPrice = parseFloat(itemConfig.defaults.bonusPrice) || 0;
                    const bonusName = `${itemConfig.defaults.name}ç‰¹å…¸`;
                    if (bonusPrice > 0) {
                        requiredBonuses.set(bonusName, bonusPrice);
                    }
                }
            });

            // 2. è®°å½•å½“å‰è¡¨æ ¼ä¸­å·²å­˜åœ¨çš„è‡ªåŠ¨ç”Ÿæˆç‰¹å…¸è¡Œ
            const existingRows = new Map();
            bonusTableBody.querySelectorAll('tr[data-autogen="true"]').forEach(row => {
                const kindInput = row.querySelector('input[data-type="kind"]');
                if (kindInput && kindInput.value) {
                    existingRows.set(kindInput.value, row);
                }
            });

            // 3. éå†åº”è¯¥å­˜åœ¨çš„ç‰¹å…¸ï¼Œæ›´æ–°æˆ–æ·»åŠ è¡Œ
            requiredBonuses.forEach((price, name) => {
                const existingRow = existingRows.get(name);
                if (existingRow) {
                    // å¦‚æœè¡Œå·²å­˜åœ¨ï¼Œåªæ›´æ–°ä»·æ ¼ï¼Œä¸å½±å“ç”¨æˆ·è¾“å…¥
                    const priceInput = existingRow.querySelector('input[data-type="price"]');
                    if (priceInput) {
                        priceInput.value = price.toFixed(2);
                    }
                    // ä»mapä¸­ç§»é™¤ï¼Œè¡¨ç¤ºå·²å¤„ç†
                    existingRows.delete(name);
                } else {
                    // å¦‚æœè¡Œä¸å­˜åœ¨ï¼Œåˆ™æ·»åŠ æ–°è¡Œ
                    const existingCustomBonuses = new Set();
                    bonusTableBody.querySelectorAll('tr:not([data-autogen="true"])').forEach(row => {
                        const kindInput = row.querySelector('input[data-type="kind"]');
                        if (kindInput) existingCustomBonuses.add(kindInput.value.trim());
                    });

                    if (!existingCustomBonuses.has(name)) {
                        const newIndex = bonusTableBody.rows.length;
                        const newRow = bonusTableBody.insertRow();
                        populateTableRow(newRow, 'bonus', newIndex, { kind: name, price: price.toFixed(2), isAutoGen: true });
                    }
                }
            });

            // 4. ç§»é™¤ä¸å†éœ€è¦çš„ç‰¹å…¸è¡Œï¼ˆä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªç›’å­çš„ç‰¹å…¸ä»·æ ¼è¢«æ¸…ç©ºäº†ï¼‰
            existingRows.forEach(row => {
                row.remove();
            });
        }


        function updateAllPrices() {
            const rate = getExchangeRate();
            const ceil2 = val => Math.ceil(val * 100) / 100;

            populateBonusTableFromItems();

            Object.keys(itemTypes).forEach(typeKey => {
                const itemConfig = itemTypes[typeKey];
                const table = document.getElementById(`data-table-${typeKey}`);
                if (!table) return;

                let totalAdj = 0;
                let avgPrice = 0;

                if (itemConfig.hasBonusPrice) { // Box types
                    const defaults = itemConfig.defaults;
                    const itemPrice = parseFloat(defaults.price) || 0;
                    const numChars = parseInt(defaults.chars) || 1;
                    const bonusPrice = parseFloat(defaults.bonusPrice) || 0;
                    avgPrice = numChars > 0 ? (itemPrice * rate - bonusPrice) / numChars : 0;
                }

                // æ›´æ–°æ’è¡¨
                table.querySelectorAll('tbody tr').forEach(row => {
                    const adjPrice = parseFloat(row.querySelector('.adj-price')?.value) || 0;
                    let finalPrice = 0;

                    if (typeKey === 'single') {
                        const originalPrice = parseFloat(row.querySelector('input[data-type="price"]').value) || 0;
                        finalPrice = originalPrice * rate;
                    } else if (typeKey === 'bonus') {
                        const value = parseFloat(row.querySelector('input[data-type="price"]').value) || 0;
                        finalPrice = value + adjPrice;
                        totalAdj += adjPrice;
                    } else { // Box types
                        row.querySelector('.avg-price').textContent = ceil2(avgPrice).toFixed(2);
                        finalPrice = avgPrice + adjPrice;
                        totalAdj += adjPrice;
                    }
                    row.querySelector('.final-price').textContent = ceil2(finalPrice).toFixed(2);
                });

                const warningSpan = document.getElementById(`è°ƒä»·æé†’-${typeKey}`);
                if (warningSpan) warningSpan.textContent = Math.abs(totalAdj) > 0.01 ? `è°ƒä»·æ€»å’Œä¸ä¸º0 (${totalAdj.toFixed(2)})` : '';

                // æ–°å¢ï¼šæ›´æ–°å‡ºè·é…æ¯”è¡¨æ ¼
                if (itemConfig.hasSets && !itemConfig.isDynamicTabContent) {
                    const shippingTable = document.getElementById(`shipping-table-${typeKey}`);
                    if (shippingTable) {
                        let shippingTotalAdj = 0;
                        let giftTotalValue = 0;

                        // è®¡ç®—èµ å“æ€»ä»·å€¼
                        shippingTable.querySelectorAll('tbody tr[data-isgift="true"]').forEach(row => {
                            const giftPrice = parseFloat(row.querySelector('.gift-price')?.value) || 0;
                            const distribution = getDistributionFromInputs(row);
                            const totalQty = Object.values(distribution).reduce((sum, q) => sum + q, 0);
                            giftTotalValue += giftPrice * totalQty;
                        });

                        // è®¡ç®—è°ƒæ•´åçš„å‡ä»·
                        const defaults = itemConfig.defaults;
                        const itemPrice = parseFloat(defaults.price) || 0;
                        const numChars = parseInt(defaults.chars) || 1;
                        const bonusPrice = parseFloat(defaults.bonusPrice) || 0;

                        let adjustedAvgPrice = avgPrice;
                        if (numChars > 0) {
                            const totalValue = itemPrice * rate - bonusPrice - giftTotalValue;
                            adjustedAvgPrice = totalValue / numChars;
                        }

                        // æ›´æ–°æ‰€æœ‰éèµ å“è¡Œçš„ä»·æ ¼
                        shippingTable.querySelectorAll('tbody tr').forEach(row => {
                            if (row.dataset.isgift === 'true') {
                                // èµ å“è¡Œä¸æ˜¾ç¤ºå‡ä»·å’Œç»ˆä»·
                                return;
                            }

                            const adjPrice = parseFloat(row.querySelector('.adj-price')?.value) || 0;
                            row.querySelector('.shipping-avg-price').textContent = ceil2(adjustedAvgPrice).toFixed(2);
                            const finalPrice = adjustedAvgPrice + adjPrice;
                            row.querySelector('.shipping-final-price').textContent = ceil2(finalPrice).toFixed(2);
                            shippingTotalAdj += adjPrice;
                        });

                        const shippingWarningSpan = document.getElementById(`è°ƒä»·æé†’-shipping-${typeKey}`);
                        if (shippingWarningSpan) {
                            shippingWarningSpan.textContent = Math.abs(shippingTotalAdj) > 0.01 ? `è°ƒä»·æ€»å’Œä¸ä¸º0 (${shippingTotalAdj.toFixed(2)})` : '';
                        }
                    }
                }
            });
            // æ›´æ–°å›½é™…é‚®è´¹è¡¨
            if (document.getElementById('shipping-fee-table')) {
                updateShippingFeeTable();
                updateShippingFeeCalculation();
            }

            updateAllRemainingQuantities();
        }

        function getDistributionFromInputs(row) {
            const entries = {};
            row.querySelectorAll('.dist-entry').forEach(entry => {
                const name = entry.querySelector('.dist-name').value.trim();
                const quantity = parseInt(entry.querySelector('.dist-quantity').value) || 0;
                if (name && quantity > 0) {
                    entries[name] = (entries[name] || 0) + quantity;
                }
            });
            return entries;
        }

        function calculatePageBill(typeKey) {
            const table = document.getElementById(`data-table-${typeKey}`);
            const outputDiv = document.getElementById(`page-bill-${typeKey}`);
            const bill = {};
            if (!table || !outputDiv) return;

            table.querySelectorAll('tbody tr').forEach(row => {
                let priceForBilling = parseFloat(row.querySelector('.final-price').textContent);
                const distribution = getDistributionFromInputs(row);
                for (const name in distribution) {
                    bill[name] = (bill[name] || 0) + (priceForBilling * distribution[name]);
                }
            });

            let billText = 'æœ¬é¡µè‚¾è¡¨:\n';
            if (Object.keys(bill).length === 0) billText += 'æš‚æ— æ•°æ®';
            else Object.entries(bill).sort().forEach(([name, amount]) => billText += `${name}: ${amount.toFixed(2)} å…ƒ\n`);
            outputDiv.textContent = billText;
        }

        function calculateShippingPageBill(typeKey) {
            const table = document.getElementById(`shipping-table-${typeKey}`);
            const outputDiv = document.getElementById(`shipping-page-bill-${typeKey}`);
            const bill = {};
            if (!table || !outputDiv) return;

            table.querySelectorAll('tbody tr').forEach(row => {
                // è·³è¿‡èµ å“è¡Œ
                if (row.dataset.isgift === 'true') {
                    return;
                }

                let priceForBilling = parseFloat(row.querySelector('.shipping-final-price').textContent);
                const distribution = getDistributionFromInputs(row);

                for (const name in distribution) {
                    bill[name] = (bill[name] || 0) + (priceForBilling * distribution[name]);
                }
            });

            let billText = 'æœ¬é¡µå‡ºè·è‚¾è¡¨:\n';
            if (Object.keys(bill).length === 0) billText += 'æš‚æ— æ•°æ®';
            else Object.entries(bill).sort().forEach(([name, amount]) => billText += `${name}: ${amount.toFixed(2)} å…ƒ\n`);
            outputDiv.textContent = billText;
        }

        function updateShippingFeeTable() {
            const tableBody = document.querySelector('#shipping-fee-table tbody');
            if (!tableBody) return;

            const existingData = {};
            tableBody.querySelectorAll('tr').forEach(row => {
                const typeCell = row.cells[0];
                const pointsInput = row.querySelector('input[type="number"]');
                if (typeCell && pointsInput) {
                    existingData[typeCell.textContent] = pointsInput.value;
                }
            });

            tableBody.innerHTML = '';

            // ç”Ÿæˆç›’å­ç§ç±»ï¼ˆå‡ï¼‰
            Object.keys(itemTypes).forEach(typeKey => {
                const itemConfig = itemTypes[typeKey];
                if (itemConfig && itemConfig.hasSets && !itemConfig.isDynamicTabContent) {
                    const itemName = itemConfig.defaults?.name || itemConfig.key;
                    const typeName = `${itemName}ï¼ˆå‡ï¼‰`;
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                <td class="col-name">${typeName}</td>
                <td class="col-value">
                    <input type="number" value="${existingData[typeName] || '1'}" 
                           min="0" step="0.1" 
                           oninput="updateShippingFeeCalculation()"
                           style="max-width: 80px;">
                </td>
            `;
                }
            });

            // ç”Ÿæˆå•é¢†ç§ç±»
            const singleKinds = new Set();
            const singleTable = document.getElementById('data-table-single');
            if (singleTable) {
                singleTable.querySelectorAll('tbody tr').forEach(row => {
                    const kindInput = row.querySelector('input[data-type="kind"]');
                    if (kindInput && kindInput.value.trim()) {
                        singleKinds.add(kindInput.value.trim());
                    }
                });

                singleKinds.forEach(kind => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                <td class="col-name">${kind}</td>
                <td class="col-value">
                    <input type="number" value="${existingData[kind] || '1'}" 
                           min="0" step="0.1" 
                           oninput="updateShippingFeeCalculation()"
                           style="max-width: 80px;">
                </td>
            `;
                });
            }
        }

        function updateShippingFeeCalculation() {
            const totalFeeInput = document.getElementById('total-shipping-fee');
            const tableBody = document.querySelector('#shipping-fee-table tbody');
            const totalPointsSpan = document.getElementById('total-shipping-points');
            const perPointFeeSpan = document.getElementById('per-point-fee');

            if (!totalFeeInput || !tableBody || !totalPointsSpan || !perPointFeeSpan) return;

            const totalFee = parseFloat(totalFeeInput.value) || 0;
            let totalPoints = 0;

            // 1. è®¡ç®—è‡ªåŠ¨ç”Ÿæˆé¡¹ç›®çš„æ€»ç‚¹æ•°
            tableBody.querySelectorAll('tr').forEach(row => {
                const typeName = row.cells[0].textContent;
                const pointsInput = row.querySelector('input[type="number"]');
                const pointsPerItem = parseFloat(pointsInput?.value) || 0;

                if (typeName.includes('ï¼ˆå‡ï¼‰')) {
                    const boxName = typeName.replace('ï¼ˆå‡ï¼‰', '');
                    Object.keys(itemTypes).forEach(typeKey => {
                        const itemConfig = itemTypes[typeKey];
                        if (itemConfig && itemConfig.defaults?.name === boxName) {
                            const chars = parseInt(itemConfig.defaults.chars) || 0;
                            const sets = parseInt(itemConfig.defaults.sets) || 0;
                            totalPoints += pointsPerItem * chars * sets;
                        }
                    });
                } else {
                    const singleTable = document.getElementById('data-table-single');
                    if (singleTable) {
                        singleTable.querySelectorAll('tbody tr').forEach(singleRow => {
                            const kindInput = singleRow.querySelector('input[data-type="kind"]');
                            if (kindInput && kindInput.value.trim() === typeName) {
                                const distribution = getDistributionFromInputs(singleRow);
                                const qty = Object.values(distribution).reduce((sum, q) => sum + q, 0);
                                totalPoints += pointsPerItem * qty;
                            }
                        });
                    }
                }
            });

            // 2. è®¡ç®—è‡ªå®šä¹‰é¡¹ç›®çš„æ€»ç‚¹æ•°
            const customTableBody = document.querySelector('#custom-shipping-fee-table tbody');
            if (customTableBody) {
                customTableBody.querySelectorAll('tr').forEach(row => {
                    const quantity = parseFloat(row.cells[1].querySelector('input')?.value) || 0;
                    const pointsPerItem = parseFloat(row.cells[2].querySelector('input')?.value) || 0;
                    totalPoints += quantity * pointsPerItem;
                });
            }


            totalPointsSpan.textContent = totalPoints.toFixed(1);

            const perPointFee = totalPoints > 0 ? totalFee / totalPoints : 0;
            perPointFeeSpan.textContent = (Math.ceil(perPointFee * 100) / 100).toFixed(2);
        }


        function calculateShippingFeeBill() {
            const totalFeeInput = document.getElementById('total-shipping-fee');
            const tableBody = document.querySelector('#shipping-fee-table tbody');

            if (!totalFeeInput || !tableBody) return {};

            const totalFee = parseFloat(totalFeeInput.value) || 0;
            const perPointFeeSpan = document.getElementById('per-point-fee');
            const perPointFee = parseFloat(perPointFeeSpan?.textContent) || 0;

            const shippingBill = {};
            const pointsPerType = {};

            // å…ˆæ”¶é›†æ¯ç§ç±»å‹çš„ç‚¹æ•°
            tableBody.querySelectorAll('tr').forEach(row => {
                const typeName = row.cells[0].textContent;
                const pointsInput = row.querySelector('input[type="number"]');
                pointsPerType[typeName] = parseFloat(pointsInput?.value) || 0;
            });

            // è®¡ç®—ç›’å­ç±»å‹çš„é‚®è´¹
            Object.keys(itemTypes).forEach(typeKey => {
                const itemConfig = itemTypes[typeKey];
                if (!itemConfig || itemConfig.isDynamicTabContent || typeKey === 'shipping') return;

                const table = document.getElementById(`data-table-${typeKey}`);
                if (!table) return;

                if (itemConfig.hasSets) {
                    // ç›’å­ç±»å‹
                    const boxName = itemConfig.defaults?.name || itemConfig.key;
                    const typeNameKey = `${boxName}ï¼ˆå‡ï¼‰`;
                    const pointsPerChar = pointsPerType[typeNameKey] || 0;

                    table.querySelectorAll('tbody tr').forEach(row => {
                        const distribution = getDistributionFromInputs(row);
                        for (const person in distribution) {
                            const qty = distribution[person];
                            const points = pointsPerChar * qty;
                            const fee = points * perPointFee;

                            if (!shippingBill[person]) {
                                shippingBill[person] = { points: 0, fee: 0 };
                            }
                            shippingBill[person].points += points;
                            shippingBill[person].fee += fee;
                        }
                    });
                }
            });

            // è®¡ç®—å•é¢†çš„é‚®è´¹
            const singleTable = document.getElementById('data-table-single');
            if (singleTable) {
                singleTable.querySelectorAll('tbody tr').forEach(row => {
                    const kindInput = row.querySelector('input[data-type="kind"]');
                    const kind = kindInput?.value.trim();
                    if (!kind) return;

                    const pointsPerItem = pointsPerType[kind] || 0;
                    const distribution = getDistributionFromInputs(row);

                    for (const person in distribution) {
                        const qty = distribution[person];
                        const points = pointsPerItem * qty;
                        const fee = points * perPointFee;

                        if (!shippingBill[person]) {
                            shippingBill[person] = { points: 0, fee: 0 };
                        }
                        shippingBill[person].points += points;
                        shippingBill[person].fee += fee;
                    }
                });
            }

            return shippingBill;
        }

        function calculateSummary() {
            updateAllPrices();

            // æœ¬æ¬¡è‚¾è¡¨å’Œæ’è¡¨ï¼ˆåŸºäºæ’è¡¨ï¼‰
            const currentBill = {};
            const currentItems = {};

            // å®é™…è‚¾è¡¨å’Œæ’è¡¨ï¼ˆåŸºäºå‡ºè·é…æ¯” + å•é¢†/ç‰¹å…¸ + èµ å“ï¼‰
            const actualBill = {};
            const actualItems = {};

            const rate = getExchangeRate();
            let totalCostToLeader = 0;

            Object.keys(itemTypes).forEach(typeKey => {
                const itemConfig = itemTypes[typeKey];

                // è®¡ç®—å›¢é•¿æˆæœ¬
                if (itemConfig.hasSets) {
                    const sets = parseInt(itemConfig.defaults.sets) || 0;
                    const price = parseFloat(itemConfig.defaults.price) || 0;
                    totalCostToLeader += sets * price * rate;
                }

                // === å¤„ç†æ’è¡¨æ•°æ®ï¼ˆç”¨äºè®¡ç®—â€œæœ¬æ¬¡è‚¾è¡¨/æ’è¡¨â€ï¼‰ ===
                const table = document.getElementById(`data-table-${typeKey}`);
                if (table) {
                    table.querySelectorAll('tbody tr').forEach(row => {
                        if (typeKey === 'single') {
                            const price = parseFloat(row.querySelector('input[data-type="price"]').value) || 0;
                            const dist = getDistributionFromInputs(row);
                            const quantity = Object.values(dist).reduce((s, q) => s + q, 0);
                            totalCostToLeader += price * quantity * rate;
                        }

                        let priceForBilling = parseFloat(row.querySelector('.final-price').textContent);
                        const distribution = getDistributionFromInputs(row);

                        let itemName;
                        const charName = row.querySelector('input[placeholder="è§’è‰²å..."]')?.value.trim();
                        const kindName = row.querySelector('input[data-type="kind"]')?.value.trim();

                        if (typeKey === 'single') {
                            itemName = charName && kindName ? `${charName}-${kindName}` : (charName || kindName || `é¡¹ç›®${row.dataset.index}`);
                        } else {
                            itemName = charName || kindName || `é¡¹ç›®${row.dataset.index}`;
                        }

                        for (const person in distribution) {
                            currentBill[person] = (currentBill[person] || 0) + (priceForBilling * distribution[person]);
                            if (!currentItems[person]) currentItems[person] = [];
                            currentItems[person].push(`${itemConfig.key} - ${itemName} x ${distribution[person]}`);
                        }
                    });
                }

                // === å¤„ç†å‡ºè·æ•°æ®ï¼ˆç”¨äºè®¡ç®—â€œå®é™…è‚¾è¡¨/æ’è¡¨â€ï¼‰ ===
                if (itemConfig.hasSets && !itemConfig.isDynamicTabContent) {
                    // è¿™æ˜¯ç›’å­ç±»å‹ï¼Œä½¿ç”¨â€œå‡ºè·é…æ¯”â€è¡¨
                    const shippingTable = document.getElementById(`shipping-table-${typeKey}`);
                    if (shippingTable) {
                        shippingTable.querySelectorAll('tbody tr').forEach(row => {
                            let priceForBilling = 0;
                            let itemName = '';
                            let isGift = row.dataset.isgift === 'true';

                            if (isGift) {
                                // ä¿®æ­£ï¼šå¤„ç†èµ å“è¡Œ
                                priceForBilling = parseFloat(row.querySelector('.gift-price')?.value) || 0;
                                itemName = row.querySelector('input[placeholder="èµ å“è§’è‰²..."]')?.value.trim() || 'èµ å“';
                            } else {
                                // å¤„ç†æ™®é€šè¡Œ
                                priceForBilling = parseFloat(row.querySelector('.shipping-final-price').textContent);
                                itemName = row.querySelector('input[placeholder="è§’è‰²å..."]')?.value.trim() || `é¡¹ç›®${row.dataset.index}`;
                            }

                            const distribution = getDistributionFromInputs(row);
                            for (const person in distribution) {
                                actualBill[person] = (actualBill[person] || 0) + (priceForBilling * distribution[person]);
                                if (!actualItems[person]) actualItems[person] = [];
                                const itemDisplayName = isGift ? `${itemName} (èµ å“)` : itemName;
                                actualItems[person].push(`${itemConfig.key} - ${itemDisplayName} x ${distribution[person]}`);
                            }
                        });
                    }
                } else if (typeKey === 'single' || typeKey === 'bonus') {
                    // è¿™æ˜¯å•é¢†æˆ–ç‰¹å…¸ï¼Œä½¿ç”¨å®ƒä»¬è‡ªå·±çš„ä¸»æ’è¡¨
                    const mainTable = document.getElementById(`data-table-${typeKey}`);
                    if (mainTable) {
                        mainTable.querySelectorAll('tbody tr').forEach(row => {
                            let priceForBilling = parseFloat(row.querySelector('.final-price').textContent);
                            const distribution = getDistributionFromInputs(row);

                            let itemName;
                            const charName = row.querySelector('input[placeholder="è§’è‰²å..."]')?.value.trim();
                            const kindName = row.querySelector('input[data-type="kind"]')?.value.trim();

                            if (typeKey === 'single') {
                                itemName = charName && kindName ? `${charName}-${kindName}` : (charName || kindName || `é¡¹ç›®${row.dataset.index}`);
                            } else { // bonus
                                itemName = kindName || `é¡¹ç›®${row.dataset.index}`;
                            }

                            for (const person in distribution) {
                                actualBill[person] = (actualBill[person] || 0) + (priceForBilling * distribution[person]);
                                if (!actualItems[person]) actualItems[person] = [];
                                actualItems[person].push(`${itemConfig.key} - ${itemName} x ${distribution[person]}`);
                            }
                        });
                    }
                }
            });

            // === æ˜¾ç¤ºæœ¬æ¬¡è‚¾è¡¨ ===
            const billOutput = document.getElementById('total-bill-output');
            let billText = '';
            let currentTotal = 0;
            if (Object.keys(currentBill).length > 0) {
                Object.entries(currentBill).sort().forEach(([person, amount]) => {
                    billText += `${person}: ${amount.toFixed(2)} å…ƒ\n`;
                    currentTotal += amount;
                });
            } else {
                billText = 'è¯·å…ˆåœ¨å„åˆ†è¡¨ä¸­å¡«å†™æ’è¡¨ä¿¡æ¯ã€‚';
            }
            billOutput.textContent = billText;

            // === æ˜¾ç¤ºæœ¬æ¬¡æ’è¡¨ ===
            const itemsOutput = document.getElementById('total-items-output');
            let itemsText = '';
            if (Object.keys(currentItems).length > 0) {
                Object.keys(currentItems).sort().forEach(person => {
                    itemsText += `--- ${person} ---\n${currentItems[person].join('\n')}\n\n`;
                });
            } else {
                itemsText = 'è¯·å…ˆåœ¨å„åˆ†è¡¨ä¸­å¡«å†™æ’è¡¨ä¿¡æ¯ã€‚';
            }
            itemsOutput.textContent = itemsText;

            // === æ˜¾ç¤ºå›½é™…è‚¾è¡¨ ===
            updateShippingFeeTable();
            updateShippingFeeCalculation();
            const shippingBill = calculateShippingFeeBill();
            const perPointFee = parseFloat(document.getElementById('per-point-fee')?.textContent) || 0;
            const shippingBillOutput = document.getElementById('shipping-bill-output');
            if (shippingBillOutput) {
                let shippingHTML = `<h3 style="margin-top: 0;">ã€å›½é™…é‚®è´¹ã€‘</h3>`;
                shippingHTML += `<p>æ¯ç‚¹ <span class="result-field">${perPointFee.toFixed(2)}</span> å…ƒ</p>`;

                if (Object.keys(shippingBill).length > 0) {
                    Object.entries(shippingBill).sort().forEach(([person, data]) => {
                        shippingHTML += `<div class="person-bill-item">
                    <strong>--- ${person} ---</strong><br>
                    ${data.points.toFixed(1)}ç‚¹ï¼Œ${(Math.ceil(data.fee * 100) / 100).toFixed(2)}å…ƒ
                </div>`;
                    });
                } else {
                    shippingHTML += '<p style="color: var(--light-text-color); text-align: center; font-style: italic;">æš‚æ— é‚®è´¹æ•°æ®</p>';
                }
                shippingBillOutput.innerHTML = shippingHTML;
            }

            // === æ˜¾ç¤ºå®é™…è‚¾è¡¨ ===
            const actualBillOutput = document.getElementById('actual-bill-output');
            let actualBillHTML = '';
            let actualTotal = 0;
            if (Object.keys(actualBill).length > 0) {
                Object.entries(actualBill).sort().forEach(([person, amount]) => {
                    actualBillHTML += `<div class="person-bill-item"><strong>${person}</strong>: ${amount.toFixed(2)} å…ƒ</div>`;
                    actualTotal += amount;
                });
            } else {
                actualBillHTML = '<p style="color: var(--light-text-color); text-align: center; font-style: italic;">è¯·å…ˆåœ¨å‡ºè·é…æ¯”/å•é¢†/ç‰¹å…¸ä¸­å¡«å†™ä¿¡æ¯ã€‚</p>';
            }
            actualBillOutput.innerHTML = actualBillHTML;

            // === æ˜¾ç¤ºå®é™…æ’è¡¨ ===
            const actualItemsOutput = document.getElementById('actual-items-output');
            let actualItemsHTML = '';
            if (Object.keys(actualItems).length > 0) {
                Object.keys(actualItems).sort().forEach(person => {
                    actualItemsHTML += `<div class="person-items-section">
                <div class="person-name">--- ${person} ---</div>
                ${actualItems[person].map(item => `<div class="item-line">${item}</div>`).join('')}
            </div>`;
                });
            } else {
                actualItemsHTML = '<p style="color: var(--light-text-color); text-align: center; font-style: italic;">è¯·å…ˆåœ¨å‡ºè·é…æ¯”/å•é¢†/ç‰¹å…¸ä¸­å¡«å†™ä¿¡æ¯ã€‚</p>';
            }
            actualItemsOutput.innerHTML = actualItemsHTML;

            // === è®¡ç®—é€€è¡¥ ===
            const refundOutput = document.getElementById('refund-output');
            let refundHTML = '';
            const allPeople = new Set([...Object.keys(currentBill), ...Object.keys(actualBill)]);

            if (allPeople.size > 0) {
                const refundList = [];
                const paymentList = [];

                allPeople.forEach(person => {
                    const current = currentBill[person] || 0;
                    const actual = actualBill[person] || 0;
                    const diff = current - actual;

                    if (diff > 0.01) {
                        refundList.push({ person, amount: diff });
                    } else if (diff < -0.01) {
                        paymentList.push({ person, amount: Math.abs(diff) });
                    }
                });

                if (refundList.length === 0 && paymentList.length === 0) {
                    refundHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 20px; color: var(--success-color); font-weight: bold;">âœ… æ— éœ€é€€è¡¥ï¼Œæ‰€æœ‰é‡‘é¢ä¸€è‡´ï¼</div>';
                } else {
                    // é€€æ¬¾åˆ—
                    let refundColumn = '<div class="refund-column">';
                    if (refundList.length > 0) {
                        refundList.sort((a, b) => b.amount - a.amount);
                        refundList.forEach(({ person, amount }) => {
                            refundColumn += `<div class="refund-item">${person}: ${amount.toFixed(2)} å…ƒ</div>`;
                        });
                    } else {
                        refundColumn += '<p style="text-align: center; color: var(--light-text-color); font-style: italic;">æš‚æ— </p>';
                    }
                    refundColumn += '</div>';

                    // è¡¥æ¬¾åˆ—
                    let paymentColumn = '<div class="payment-column">';
                    if (paymentList.length > 0) {
                        paymentList.sort((a, b) => b.amount - a.amount);
                        paymentList.forEach(({ person, amount }) => {
                            paymentColumn += `<div class="payment-item">${person}: ${amount.toFixed(2)} å…ƒ</div>`;
                        });
                    } else {
                        paymentColumn += '<p style="text-align: center; color: var(--light-text-color); font-style: italic;">æš‚æ— </p>';
                    }
                    paymentColumn += '</div>';

                    refundHTML = refundColumn + paymentColumn;
                }
            } else {
                refundHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 20px; color: var(--light-text-color); font-style: italic;">è¯·å…ˆå®Œæˆè‚¾è¡¨è®¡ç®—ã€‚</div>';
            }
            refundOutput.innerHTML = refundHTML;


            // === æ˜¾ç¤ºè‚¾é¢æ ¸å¯¹ ===
            document.getElementById('expected-total').textContent = totalCostToLeader.toFixed(2);
            document.getElementById('actual-total').textContent = actualTotal.toFixed(2);
            const diff = totalCostToLeader - actualTotal;
            const diffEl = document.getElementById('check-diff');
            if (Math.abs(diff) < 0.02) {
                diffEl.textContent = 'âœ… å·®é¢ä¸º0ï¼Œè´¦å¹³å•¦ï¼(å·®é¢ä»£è¡¨ä½™é‡ä»·å€¼)';
                diffEl.style.color = 'var(--success-color)';
            } else {
                diffEl.textContent = `âš ï¸ å·®é¢: ${diff.toFixed(2)} å…ƒã€‚(å·®é¢ä»£è¡¨ä½™é‡ä»·å€¼ï¼Œè¯·æ£€æŸ¥æ˜¯å¦æ‰€æœ‰ä½™é‡å‡æœªåˆ†é…)`;
                diffEl.style.color = 'var(--accent-color)';
            }

            updateRemainingTable();
        }



        function updateAllRemainingQuantities() {
            Object.keys(itemTypes).forEach(typeKey => {
                const itemConfig = itemTypes[typeKey];

                // æ›´æ–°æ’è¡¨çš„ä½™é‡
                const table = document.getElementById(`data-table-${typeKey}`);
                // ä¿®æ­£ï¼šå…è®¸ä¸º 'bonus' ç±»å‹è®¡ç®—ä½™é‡ï¼Œè§£å†³äº†ç‰¹å…¸æ•°é‡æ˜¾ç¤ºN/Açš„é—®é¢˜
                if (table && (!itemConfig.isDynamicTabContent || typeKey === 'bonus')) {
                    let baseQuantity = 0;
                    if (itemConfig.hasSets) {
                        baseQuantity = parseInt(itemConfig.defaults.sets) || 0;
                    } else if (typeKey === 'bonus') {
                        // å¯¹äºæ‰‹åŠ¨æ·»åŠ çš„ç‰¹å…¸ï¼Œé»˜è®¤åŸºæ•°ä¸º1
                        baseQuantity = 1;
                    }

                    table.querySelectorAll('tbody tr').forEach(row => {
                        const distribution = getDistributionFromInputs(row);
                        const totalDistributed = Object.values(distribution).reduce((sum, q) => sum + q, 0);

                        let specificBaseQty = baseQuantity;
                        // å¯¹äºè‡ªåŠ¨ç”Ÿæˆçš„ç‰¹å…¸ï¼Œå…¶åŸºæ•°åº”ç­‰äºå¯¹åº”ç›’å­çš„ç›’æ•°
                        if (typeKey === 'bonus' && row.dataset.autogen === 'true') {
                            const bonusName = row.querySelector('input[data-type="kind"]')?.value;
                            const sourceItemKey = Object.keys(itemTypes).find(k => itemTypes[k].defaults?.name + 'ç‰¹å…¸' === bonusName);
                            if (sourceItemKey) {
                                specificBaseQty = parseInt(itemTypes[sourceItemKey].defaults.sets) || 0;
                            } else {
                                specificBaseQty = 0; // å¦‚æœæ‰¾ä¸åˆ°æºç›’å­ï¼Œåˆ™åŸºæ•°ä¸º0
                            }
                        }

                        const remaining = specificBaseQty - totalDistributed;
                        const remainingCell = row.querySelector('.remaining-quantity');
                        if (remainingCell) {
                            remainingCell.textContent = remaining;
                        }
                    });
                }

                // æ–°å¢ï¼šæ›´æ–°å‡ºè·é…æ¯”çš„ä½™é‡
                if (itemConfig.hasSets && !itemConfig.isDynamicTabContent) {
                    const shippingTable = document.getElementById(`shipping-table-${typeKey}`);
                    if (shippingTable) {
                        const baseQuantity = parseInt(itemConfig.defaults.sets) || 0;

                        shippingTable.querySelectorAll('tbody tr').forEach(row => {
                            if (row.classList.contains('gift-marker-row')) return;

                            const distribution = getDistributionFromInputs(row);
                            const totalDistributed = Object.values(distribution).reduce((sum, q) => sum + q, 0);
                            const remaining = baseQuantity - totalDistributed;

                            const remainingCell = row.querySelector('.shipping-remaining-quantity');
                            if (remainingCell) remainingCell.textContent = remaining;
                        });
                    }
                }
            });
        }

        function updateRemainingTable() {
            updateAllRemainingQuantities();
            const outputDiv = document.getElementById('remaining-output');
            let html = '';
            let hasAnyRemaining = false;

            Object.keys(itemTypes).forEach(typeKey => {
                const itemConfig = itemTypes[typeKey];
                if (typeKey === 'single') return; // single items don't have ä½™é‡

                const table = document.getElementById(`data-table-${typeKey}`);
                if (!table) return;

                const remainingItems = [];
                table.querySelectorAll('tbody tr').forEach(row => {
                    const remainingCell = row.querySelector('.remaining-quantity');
                    if (!remainingCell) return;

                    const remainingNum = parseFloat(remainingCell.textContent);
                    if (isNaN(remainingNum) || remainingNum === 0) return;

                    const price = parseFloat(row.querySelector('.final-price')?.textContent) || 0;
                    const name = row.querySelector('input[placeholder="è§’è‰²å..."]')?.value || row.querySelector('input[data-type="kind"]')?.value || `é¡¹ç›®${row.dataset.index}`;
                    remainingItems.push({ name, price, remaining: remainingNum });
                });

                if (remainingItems.length > 0) {
                    hasAnyRemaining = true;
                    html += `<div class="calc-section" style="margin-bottom: 20px;">
                                <h3 style="margin-top: 0;">${itemConfig.key}</h3>
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead><tr style="background-color: var(--highlight-bg);"><th style="text-align: left; padding: 8px;">é¡¹ç›®</th><th style="padding: 8px;">ä»·æ ¼</th><th style="padding: 8px;">ä½™é‡</th></tr></thead><tbody>`;
                    remainingItems.forEach(item => {
                        html += `<tr><td style="text-align: left; padding: 8px;">${item.name}</td><td style="padding: 8px;">${item.price.toFixed(2)}</td><td style="padding: 8px;">${item.remaining}</td></tr>`;
                    });
                    html += `</tbody></table></div>`;
                }
            });

            if (!hasAnyRemaining) {
                html = '<p style="color: var(--light-text-color); text-align: center; font-style: italic; margin-top: 20px;">æš‚æ— ä½™é‡æ•°æ®ï¼Œæˆ–æ‰€æœ‰å•†å“ä½™é‡å‡ä¸º0ã€‚</p>';
            }
            outputDiv.innerHTML = html;
        }

        // --- MODALS & EXPORT ---
        function showDataSyncModal() { document.getElementById('data-sync-modal').style.display = 'block'; }
        function hideDataSyncModal() { document.getElementById('data-sync-modal').style.display = 'none'; }

        function showLoadModal() {
            const allSaves = JSON.parse(localStorage.getItem(SAVE_MANIFEST_KEY) || '{}');
            const listContainer = document.getElementById('load-modal-list');
            listContainer.innerHTML = '';
            const slotNames = Object.keys(allSaves).length > 0 ? Object.keys(allSaves) : [DEFAULT_SLOT_NAME];
            if (!slotNames.includes(DEFAULT_SLOT_NAME)) slotNames.unshift(DEFAULT_SLOT_NAME);

            slotNames.forEach(slotName => {
                const div = document.createElement('div');
                div.style.display = 'flex';
                div.style.justifyContent = 'space-between';
                div.style.alignItems = 'center';
                div.style.padding = '5px 0';

                let displayName = slotName === currentSlotName ? `<strong>${slotName} (å½“å‰)</strong>` : slotName;
                div.innerHTML = `<span>${displayName}</span>
                    <div>
                        <button onclick="loadSlot('${slotName}')" style="padding: 5px 10px; font-size: 0.9em; margin-right: 5px;">è¯»å–</button>
                        ${slotName !== DEFAULT_SLOT_NAME ? `<button onclick="deleteSlot('${slotName}')" class="remove-btn-text" style="font-size:1.2em;">Ã—</button>` : ''}
                    </div>`;
                listContainer.appendChild(div);
            });
            document.getElementById('load-modal').style.display = 'block';
        }
        function hideLoadModal() { document.getElementById('load-modal').style.display = 'none'; }

        function loadSlot(slotName) {
            saveData(true);
            if (confirm(`å½“å‰å­˜æ¡£ã€${currentSlotName}ã€‘å·²è‡ªåŠ¨ä¿å­˜ã€‚ç¡®å®šè¦åˆ‡æ¢å¹¶è¯»å–æ¡£æ¡ˆã€${slotName}ã€‘å—ï¼Ÿ`)) {
                localStorage.setItem(ACTIVE_SLOT_KEY, slotName);
                location.reload();
            }
        }
        function deleteSlot(slotName) {
            if (confirm(`ç¡®å®šè¦æ°¸ä¹…åˆ é™¤æ¡£æ¡ˆ "${slotName}" å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚`)) {
                const allSaves = JSON.parse(localStorage.getItem(SAVE_MANIFEST_KEY) || '{}');
                delete allSaves[slotName];
                localStorage.setItem(SAVE_MANIFEST_KEY, JSON.stringify(allSaves));
                if (currentSlotName === slotName) {
                    localStorage.setItem(ACTIVE_SLOT_KEY, DEFAULT_SLOT_NAME);
                    location.reload();
                } else {
                    showLoadModal();
                }
            }
        }

        function downloadExcelWorkbook(workbook, fileName) {
            try { XLSX.writeFile(workbook, fileName); }
            catch (error) { alert("å¯¼å‡ºExcelå¤±è´¥: " + error); }
        }

        function getTablesDataForExport() {
            const allSheetsData = {};
            orderedTypesForTabs.forEach(typeKey => {
                const itemConfig = itemTypes[typeKey];
                const sheetData = [];
                const table = document.getElementById(`data-table-${typeKey}`);
                if (!table) return;

                const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.replace(/<span.*<\/span>/g, '').trim());
                if (headers.includes('æ’è¡¨')) {
                    const æ’è¡¨Index = headers.indexOf('æ’è¡¨'); // <--- ä¿®æ­£å°±åœ¨è¿™ä¸€è¡Œï¼Œåœ¨constå’Œâ€œæ’è¡¨Indexâ€ä¹‹é—´åŠ äº†ä¸€ä¸ªç©ºæ ¼
                    headers.splice(æ’è¡¨Index, 1, 'åˆ†é…ç»™', 'æ•°é‡');
                }
                sheetData.push(headers);

                table.querySelectorAll('tbody tr').forEach(row => {
                    const baseRowData = Array.from(row.cells).map((td, idx) => {
                        if (td.classList.contains('col-distribution')) return 'DIST_PLACEHOLDER';
                        const input = td.querySelector('input');
                        return input ? input.value : td.textContent.trim();
                    });

                    const distributionEntries = [];
                    row.querySelectorAll('.dist-entry').forEach(entry => {
                        const name = entry.querySelector('.dist-name').value.trim();
                        const quantity = entry.querySelector('.dist-quantity').value.trim();
                        if (name || quantity) distributionEntries.push({ name, quantity });
                    });

                    const distColIndex = baseRowData.indexOf('DIST_PLACEHOLDER');
                    if (distributionEntries.length > 0) {
                        distributionEntries.forEach(dist => {
                            const fullRow = [...baseRowData];
                            fullRow.splice(distColIndex, 1, dist.name, dist.quantity);
                            sheetData.push(fullRow);
                        });
                    } else {
                        if (distColIndex > -1) baseRowData.splice(distColIndex, 1, '', '');
                        sheetData.push(baseRowData);
                    }
                });
                allSheetsData[`æ’è¡¨-${itemConfig.key}`] = sheetData;
            });
            return allSheetsData;
        }


        function getSummaryDataForExport() {
            calculateSummary();
            const sheets = {};
            const billOutputEl = document.getElementById('total-bill-output');
            const billData = [['å›¢å‘˜', 'é‡‘é¢ (å…ƒ)']];
            billOutputEl.textContent.split('\n').forEach(line => {
                if (line.includes(':')) {
                    const parts = line.split(':');
                    billData.push([parts[0].trim(), parts[1].replace('å…ƒ', '').trim()]);
                }
            });
            sheets["æ€»è‚¾è¡¨"] = billData;

            const itemsOutputEl = document.getElementById('total-items-output');
            const itemsData = [['å›¢å‘˜', 'ç‰©å“', 'æ•°é‡']];
            let currentPerson = null;
            itemsOutputEl.textContent.split('\n').forEach(line => {
                if (line.startsWith('--- ')) currentPerson = line.substring(4, line.length - 4).trim();
                else if (currentPerson && line.includes(' x ')) {
                    const parts = line.split(' x ');
                    itemsData.push([currentPerson, parts[0].trim(), parts[1].trim()]);
                }
            });
            sheets["æ€»æ’è¡¨"] = itemsData;

            const checkData = [['é¡¹ç›®', 'å€¼']];
            document.querySelectorAll('#check-total-output p').forEach(p => {
                const text = p.textContent.trim();
                const valueEl = p.querySelector('span.result-field');
                if (valueEl) {
                    checkData.push([text.split(':')[0].trim(), valueEl.textContent]);
                } else if (p.id === 'check-diff') {
                    checkData.push(['æ ¸å¯¹ä¿¡æ¯', text]);
                }
            });
            sheets["è‚¾é¢æ ¸å¯¹"] = checkData;
            return sheets;
        }

        function exportRemainingData() {
            updateRemainingTable(); // ç¡®ä¿æ•°æ®æ˜¯æ›´æ–°çš„
            const outputDiv = document.getElementById('remaining-output');
            const sheetData = [['ç§ç±»', 'é¡¹ç›®', 'ä»·æ ¼', 'ä½™é‡']];
            let hasData = false;

            outputDiv.querySelectorAll('.calc-section').forEach(section => {
                const itemType = section.querySelector('h3').textContent.trim();
                section.querySelectorAll('tbody tr').forEach(row => {
                    hasData = true;
                    const cells = row.querySelectorAll('td');
                    const itemName = cells[0].textContent.trim();
                    const price = cells[1].textContent.trim();
                    const remaining = cells[2].textContent.trim();
                    sheetData.push([itemType, itemName, price, remaining]);
                });
            });

            if (!hasData) {
                alert('æ²¡æœ‰ä½™é‡æ•°æ®å¯ä»¥å¯¼å‡ºã€‚');
                return;
            }

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(sheetData);
            XLSX.utils.book_append_sheet(wb, ws, 'ä½™é‡');
            downloadExcelWorkbook(wb, 'æ—¥è°·æ‰“è¡¨æœº-ä½™é‡.xlsx');
        }

        function exportTablesData() {
            const sheetsData = getTablesDataForExport();
            const wb = XLSX.utils.book_new();
            for (const sheetName in sheetsData) {
                const ws = XLSX.utils.aoa_to_sheet(sheetsData[sheetName]);
                XLSX.utils.book_append_sheet(wb, ws, sheetName);
            }
            downloadExcelWorkbook(wb, `æ—¥è°·æ‰“è¡¨æœº-æ’è¡¨.xlsx`);
        }
        function exportSummaryData() {
            const sheetsData = getSummaryDataForExport();
            const wb = XLSX.utils.book_new();
            for (const sheetName in sheetsData) {
                const ws = XLSX.utils.aoa_to_sheet(sheetsData[sheetName]);
                XLSX.utils.book_append_sheet(wb, ws, sheetName);
            }
            downloadExcelWorkbook(wb, `æ—¥è°·æ‰“è¡¨æœº-è‚¾è¡¨.xlsx`);
        }
        function exportAllData() {
            const wb = XLSX.utils.book_new();
            const tablesSheets = getTablesDataForExport();
            for (const name in tablesSheets) XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(tablesSheets[name]), name);
            const summarySheets = getSummaryDataForExport();
            for (const name in summarySheets) XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(summarySheets[name]), name);
            downloadExcelWorkbook(wb, `æ—¥è°·æ‰“è¡¨æœº-å…¨éƒ¨æ•°æ®.xlsx`);
        }

        function exportAllDataAsJson() {
            const allSaves = JSON.parse(localStorage.getItem(SAVE_MANIFEST_KEY) || '{}');
            const dataToExport = allSaves[currentSlotName];
            if (!dataToExport) { alert("å½“å‰å­˜æ¡£æ²¡æœ‰æ•°æ®å¯å¯¼å‡ºã€‚"); return; }
            const blob = new Blob([JSON.stringify(dataToExport, null, 2)], { type: "application/json;charset=utf-8" });
            const fileName = `KiguMachine-${currentSlotName}.json`;
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            link.click();
            URL.revokeObjectURL(link.href);
            hideDataSyncModal();
        }

        function handleJsonFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedJson = JSON.parse(e.target.result);
                    if (confirm(`å¯¼å…¥æ•°æ®å°†ä¼šè¦†ç›–å½“å‰å­˜æ¡£ã€${currentSlotName}ã€‘çš„å†…å®¹ï¼Œç¡®å®šå—ï¼Ÿ`)) {
                        loadData(importedJson);
                        alert('æ•°æ®å¯¼å…¥æˆåŠŸï¼');
                    }
                } catch (error) {
                    alert("å¯¼å…¥JSONæ–‡ä»¶å¤±è´¥: " + error.message);
                } finally {
                    event.target.value = '';
                    hideDataSyncModal();
                }
            };
            reader.readAsText(file);
        }

        function getCurrentUIData() {
            const data = {
                tables: {},
                shippingTables: {}
            };

            Object.keys(itemTypes).forEach(typeKey => {
                const itemConfig = itemTypes[typeKey];
                if (!itemConfig) return;

                const dataTableKey = itemConfig.key;

                // ä¿å­˜æ’è¡¨æ•°æ®
                data.tables[dataTableKey] = [];
                const table = document.getElementById(`data-table-${typeKey}`);
                if (table) {
                    table.querySelectorAll('tbody tr').forEach(row => {
                        const rowData = { distribution: [] };
                        let hasContent = false;

                        const charNameInput = row.querySelector('input[placeholder="è§’è‰²å..."]');
                        if (charNameInput) rowData.charName = charNameInput.value.trim();

                        const kindInput = row.querySelector('input[data-type="kind"]');
                        if (kindInput) rowData.kind = kindInput.value.trim();

                        if (rowData.charName || rowData.kind) hasContent = true;

                        const priceInput = row.querySelector('input[data-type="price"]');
                        if (priceInput) rowData.price = priceInput.value.trim();
                        if (rowData.price) hasContent = true;

                        const adjPriceInput = row.querySelector('.adj-price');
                        if (adjPriceInput) rowData.adjPrice = adjPriceInput.value;
                        if (parseFloat(rowData.adjPrice) !== 0) hasContent = true;

                        rowData.isAutoGen = row.dataset.autogen === 'true';

                        row.querySelectorAll('.dist-entry').forEach(entry => {
                            const name = entry.querySelector('.dist-name').value.trim();
                            const quantity = entry.querySelector('.dist-quantity').value.trim();
                            if (name || quantity) {
                                rowData.distribution.push({ name, quantity });
                                hasContent = true;
                            }
                        });

                        if (itemConfig.hasChars || hasContent) {
                            data.tables[dataTableKey].push(rowData);
                        }
                    });
                }

                // ä¿å­˜å‡ºè·é…æ¯”æ•°æ®
                if (itemConfig.hasSets && !itemConfig.isDynamicTabContent) {
                    data.shippingTables[dataTableKey] = [];
                    const shippingTable = document.getElementById(`shipping-table-${typeKey}`);
                    if (shippingTable) {
                        shippingTable.querySelectorAll('tbody tr').forEach(row => {
                            const rowData = { distribution: [] };
                            let hasContent = false;

                            if (row.dataset.isgift === 'true') {
                                rowData.isGift = true;
                                const charNameInput = row.querySelector('input[placeholder="èµ å“è§’è‰²..."]');
                                if (charNameInput) rowData.charName = charNameInput.value.trim();
                                const giftPriceInput = row.querySelector('.gift-price');
                                if (giftPriceInput) rowData.giftPrice = giftPriceInput.value;
                                hasContent = true;
                            } else {
                                const charNameInput = row.querySelector('input[placeholder="è§’è‰²å..."]');
                                if (charNameInput) rowData.charName = charNameInput.value.trim();
                                if (rowData.charName) hasContent = true;

                                const adjPriceInput = row.querySelector('.adj-price');
                                if (adjPriceInput) rowData.adjPrice = adjPriceInput.value;
                                if (parseFloat(rowData.adjPrice) !== 0) hasContent = true;

                                rowData.isFromSync = row.dataset.fromsync === 'true';
                            }

                            row.querySelectorAll('.dist-entry').forEach(entry => {
                                const name = entry.querySelector('.dist-name').value.trim();
                                const quantity = entry.querySelector('.dist-quantity').value.trim();
                                if (name || quantity) {
                                    rowData.distribution.push({ name, quantity });
                                    hasContent = true;
                                }
                            });

                            if (hasContent) {
                                data.shippingTables[dataTableKey].push(rowData);
                            }
                        });
                    }
                }
            });
            return data;
        }

        function addNewCustomItemType() {
            // 1. å…ˆè·å–å½“å‰ç•Œé¢ä¸Šçš„æ‰€æœ‰æ•°æ®
            const currentData = getCurrentUIData();

            // 2. åˆ›å»ºæ–°çš„å•†å“ç±»å‹
            dynamicItemCounter++;
            const newTypeKey = `custom_${dynamicItemCounter}`;
            const newItemName = prompt("è¯·è¾“å…¥æ–°å•†å“ç±»å‹çš„åç§°:", `è‡ªå®šä¹‰å•†å“ ${dynamicItemCounter}`);
            if (!newItemName) {
                dynamicItemCounter--;
                return;
            }

            itemTypes[newTypeKey] = {
                id_prefix: newTypeKey, key: newItemName,
                defaults: { name: newItemName, price: '', chars: '1', sets: '0', bonusPrice: '0' },
                hasChars: true, hasSets: true, setsLabel: 'ç›’æ•°', hasBonusPrice: true, isDynamic: true
            };
            orderedTypesForTabs.splice(orderedTypesForTabs.indexOf('single'), 0, newTypeKey);

            // 3. ä½¿ç”¨åˆšåˆšä¿å­˜çš„æ•°æ®é‡æ–°ç”Ÿæˆæ‰€æœ‰è¡¨æ ¼ï¼ˆåŒ…æ‹¬æ–°çš„è¿™ä¸€ä¸ªï¼‰
            generateTables(currentData.tables, currentData.shippingTables);
            showItemTab(newTypeKey);
        }


        function removeDynamicItemType(typeKeyToRemove) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤å•†å“ç±»å‹ "${itemTypes[typeKeyToRemove].key}" å—ï¼Ÿå…¶æ‰€æœ‰é…ç½®å’Œæ’è¡¨æ•°æ®éƒ½å°†ä¸¢å¤±ã€‚`)) {
                delete itemTypes[typeKeyToRemove];
                orderedTypesForTabs = orderedTypesForTabs.filter(key => key !== typeKeyToRemove);
                generateTables(null);
                if (orderedTypesForTabs.length > 0) showItemTab(orderedTypesForTabs[0]);
            }
        }

        // --- AUTOCOMPLETE (REBUILT) ---
        let allCharacterNames = new Set();
        let allMemberNames = new Set();
        let allKindNames = new Set();

        function updateNameCaches() {
            allCharacterNames.clear();
            allMemberNames.clear();
            allKindNames.clear();

            // æ‰«ææ‰€æœ‰è§’è‰²åè¾“å…¥æ¡†ï¼ˆåŒ…æ‹¬ç›’å­ã€å•é¢†å’Œèµ å“çš„ï¼‰
            // ä¿®æ­£ï¼šå¢åŠ äº†å¯¹ 'input[placeholder="èµ å“è§’è‰²..."]' çš„æ‰«æ
            document.querySelectorAll('input[placeholder="è§’è‰²å..."], input[placeholder="èµ å“è§’è‰²..."]').forEach(input => {
                if (input.value.trim()) {
                    allCharacterNames.add(input.value.trim());
                }
            });

            // æ‰«ææ‰€æœ‰å›¢å‘˜åè¾“å…¥æ¡†
            document.querySelectorAll('input.dist-name').forEach(input => {
                if (input.value.trim()) {
                    allMemberNames.add(input.value.trim());
                }
            });

            // æ‰«ææ‰€æœ‰ç§ç±»è¾“å…¥æ¡†ï¼ˆå•é¢†è¡¨æ ¼ä¸­çš„ï¼‰
            document.querySelectorAll('#data-table-single input[data-type="kind"]').forEach(input => {
                if (input.value.trim()) {
                    allKindNames.add(input.value.trim());
                }
            });
        }

        function setupAutocomplete() {
            const suggestionBox = document.getElementById('autocomplete-suggestions');
            let activeSuggestionInput = null;
            let activeSuggestionIndex = -1;

            function repositionSuggestionBox() {
                if (!activeSuggestionInput) return;
                const rect = activeSuggestionInput.getBoundingClientRect();
                suggestionBox.style.left = `${rect.left}px`;
                suggestionBox.style.top = `${rect.bottom}px`;
                suggestionBox.style.width = `${rect.width}px`;
            }

            function showSuggestions(inputElement, nameSet, filter = '') {
                const suggestions = [...nameSet].filter(name => name.toLowerCase().includes(filter.toLowerCase()));

                if (suggestions.length === 0) {
                    hideSuggestions();
                    return;
                }

                suggestionBox.innerHTML = '';
                suggestions.forEach(name => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    item.textContent = name;
                    item.addEventListener('mousedown', (e) => {
                        e.preventDefault();
                        inputElement.value = name;
                        hideSuggestions();
                        inputElement.dispatchEvent(new Event('input', { bubbles: true }));
                    });
                    suggestionBox.appendChild(item);
                });

                repositionSuggestionBox();
                suggestionBox.style.display = 'block';
                activeSuggestionIndex = -1;
            }

            function hideSuggestions() {
                suggestionBox.style.display = 'none';
                activeSuggestionInput = null;
            }

            function handleKeyDown(e) {
                if (!activeSuggestionInput || suggestionBox.style.display === 'none') return;

                const items = suggestionBox.querySelectorAll('.suggestion-item');
                if (items.length === 0) return;

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    activeSuggestionIndex = (activeSuggestionIndex + 1) % items.length;
                    updateActiveSuggestion(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    activeSuggestionIndex = (activeSuggestionIndex - 1 + items.length) % items.length;
                    updateActiveSuggestion(items);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (activeSuggestionIndex > -1) {
                        items[activeSuggestionIndex].dispatchEvent(new MouseEvent('mousedown'));
                    }
                    hideSuggestions();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    hideSuggestions();
                }
            }

            function updateActiveSuggestion(items) {
                items.forEach(item => item.classList.remove('active'));
                if (activeSuggestionIndex > -1) {
                    items[activeSuggestionIndex].classList.add('active');
                    items[activeSuggestionIndex].scrollIntoView({ block: 'nearest' });
                }
            }

            document.addEventListener('focusin', (e) => {
                const target = e.target;
                let nameSet = null;

                // ä¿®æ­£ï¼šå¢åŠ äº†å¯¹ 'input[placeholder="èµ å“è§’è‰²..."]' çš„åŒ¹é…
                if (target.matches('input[placeholder="è§’è‰²å..."], input[placeholder="èµ å“è§’è‰²..."]')) {
                    nameSet = allCharacterNames;
                } else if (target.matches('input.dist-name')) {
                    nameSet = allMemberNames;
                } else if (target.matches('#data-table-single input[data-type="kind"]')) {
                    nameSet = allKindNames;
                }

                if (nameSet) {
                    activeSuggestionInput = target;
                    updateNameCaches();
                    showSuggestions(target, nameSet, target.value);
                }
            });

            document.addEventListener('input', (e) => {
                if (e.target === activeSuggestionInput) {
                    let nameSet = null;
                    // ä¿®æ­£ï¼šå¢åŠ äº†å¯¹ 'input[placeholder="èµ å“è§’è‰²..."]' çš„åŒ¹é…
                    if (e.target.matches('input[placeholder="è§’è‰²å..."], input[placeholder="èµ å“è§’è‰²..."]')) {
                        nameSet = allCharacterNames;
                    } else if (e.target.matches('input.dist-name')) {
                        nameSet = allMemberNames;
                    } else if (e.target.matches('#data-table-single input[data-type="kind"]')) {
                        nameSet = allKindNames;
                    }
                    if (nameSet) {
                        showSuggestions(e.target, nameSet, e.target.value);
                    }
                }
            });

            document.addEventListener('click', (e) => {
                if (e.target !== activeSuggestionInput && !suggestionBox.contains(e.target)) {
                    hideSuggestions();
                }
            });

            document.addEventListener('blur', (e) => {
                // ä¿®æ­£ï¼šå¢åŠ äº†å¯¹ 'input[placeholder="èµ å“è§’è‰²..."]' çš„åŒ¹é…
                if (e.target.matches('input[placeholder="è§’è‰²å..."], input[placeholder="èµ å“è§’è‰²..."]') ||
                    e.target.matches('input.dist-name') ||
                    e.target.matches('#data-table-single input[data-type="kind"]')) {
                    updateNameCaches();
                }
            }, true);

            document.addEventListener('keydown', handleKeyDown);

            const updatePositionOnScrollOrResize = () => {
                if (suggestionBox.style.display === 'block') {
                    repositionSuggestionBox();
                }
            };
            window.addEventListener('scroll', updatePositionOnScrollOrResize, true);
            window.addEventListener('resize', updatePositionOnScrollOrResize);
        }

        function copyToClipboard(elementId, buttonElement) {
            const element = document.getElementById(elementId);
            if (!element) return;
            let textToCopy = element.innerText || element.textContent;

            if (element.querySelector('table')) { // Format table text
                textToCopy = '';
                element.querySelectorAll('.calc-section').forEach(section => {
                    textToCopy += section.querySelector('h3').textContent.trim() + '\n';
                    section.querySelectorAll('tr').forEach(row => {
                        textToCopy += Array.from(row.querySelectorAll('th, td')).map(cell => cell.textContent.trim()).join('\t') + '\n';
                    });
                    textToCopy += '\n';
                });
            }

            navigator.clipboard.writeText(textToCopy.trim()).then(() => {
                const originalText = buttonElement.textContent;
                buttonElement.textContent = 'âœ… å·²å¤åˆ¶';
                setTimeout(() => { buttonElement.textContent = originalText; }, 2000);
            }).catch(err => alert('å¤åˆ¶å¤±è´¥: ' + err));
        }

    </script>
</body>

</html>
